<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>SanYuan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="SanYuan">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="SanYuan">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="SanYuan">
  
    <link rel="alternate" href="/atom.xml" title="SanYuan" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">SanYuan</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-CentOS-6-x-KickStart" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/15/CentOS-6-x-KickStart/" class="article-date">
  <time datetime="2016-12-15T03:30:02.000Z" itemprop="datePublished">2016-12-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/15/CentOS-6-x-KickStart/">CentOS 6.x KickStart</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>vim /etc/dhcp/dhcpd.conf<br>subnet 192.168.3.0 netmask 255.255.255.0 {<br>        range 192.168.3.100 192.168.3.200;<br>        option subnet-mask 255.255.255.0;<br>option domain-name-servers 114.114.114.114;<br>option domain-name-servers 223.5.5.5;<br>        default-lease-time 21600;<br>        max-lease-time 43200;<br>        next-server 192.168.3.3;<br>        filename “/pxelinux.0”;<br>}</p>
<p>[root@localhost ~]# vim /etc/sysconfig/dhcpd</p>
<h1 id="Command-line-options-here"><a href="#Command-line-options-here" class="headerlink" title="Command line options here"></a>Command line options here</h1><p>DHCPDARGS=eth1</p>
<p>/etc/init.d/dhcpd restart<br>netstat -tunlp|grep dhcp<br>[root@localhost ~]# chkconfig dhcpd on<br>[root@localhost ~]# chkconfig –list | grep dhcpd<br>dhcpd           0:off   1:off   2:on    3:on    4:on    5:on    6:off</p>
<p>yum -y install tftp-server<br>[root@localhost ~]# vim /etc/xinetd.d/tftp</p>
<p>  1 # default: off<br>  2 # description: The tftp server serves files using the trivial file transfer     \<br>  3 #       protocol.  The tftp protocol is often used to boot diskless \<br>  4 #       workstations, download configuration files to network-aware printers    , \<br>  5 #       and to start the installation process for some operating systems.<br>  6 service tftp<br>  7 {<br>  8         socket_type             = dgram<br>  9         protocol                = udp<br> 10         wait                    = yes<br> 11         user                    = root<br> 12         server                  = /usr/sbin/in.tftpd<br> 13         server_args             = -s /var/lib/tftpboot<br> 14         disable                 = no<br> 15         per_source              = 11<br> 16         cps                     = 100 2<br> 17         flags                   = IPv4<br> 18 }<br>~<br>~<br>~<br>“/etc/xinetd.d/tftp” 18L, 517C written<br>[root@localhost ~]#<br>[root@localhost ~]# /etc/init.d/xinetd start<br>Starting xinetd: [  OK  ]<br>[root@localhost ~]# netstat -tunlp|grep 69<br>udp        0      0 0.0.0.0:67                  0.0.0.0:<em>                               1691/dhcpd<br>udp        0      0 0.0.0.0:69                  0.0.0.0:</em>                               2108/xinetd<br>[root@localhost ~]# </p>
<p>Complete!</p>
<p>[root@localhost ~]# yum -y install httpd<br>[root@localhost ~]# sed -i “277i ServerName 127.0.0.1:80” /etc/httpd/conf/httpd.conf<br>[root@localhost ~]# /etc/init.d/httpd start<br>Starting httpd: [  OK  ]<br>[root@localhost ~]#<br>[root@server ~]# chkconfig httpd on<br>[root@server ~]# chkconfig –list |grep httpd<br>httpd           0:off   1:off   2:on    3:on    4:on    5:on    6:off<br>[root@localhost ~]# mkdir /var/www/html/CentOS-6.5</p>
<p>[root@localhost ~]# mount /dev/cdrom /var/www/html/CentOS-6.5<br>mount: block device /dev/sr0 is write-protected, mounting read-only<br>[root@localhost ~]# df -h<br>Filesystem                     Size  Used Avail Use% Mounted on<br>/dev/mapper/VolGroup-LogVol00   28G  3.7G   23G  14% /<br>tmpfs                         1004M   84K 1004M   1% /dev/shm<br>/dev/sda1                      194M   35M  150M  19% /boot<br>/dev/sr0                       4.2G  4.2G     0 100% /media/CentOS_6.5_Final<br>/dev/sr0                       4.2G  4.2G     0 100% /var/www/html/CentOS-6.5<br>[root@localhost ~]# ls /var/www/html/CentOS-6.5<br>CentOS_BuildTag  isolinux                  RPM-GPG-KEY-CentOS-Debug-6<br>EFI              Packages                  RPM-GPG-KEY-CentOS-Security-6<br>EULA             RELEASE-NOTES-en-US.html  RPM-GPG-KEY-CentOS-Testing-6<br>GPL              repodata                  TRANS.TBL<br>images           RPM-GPG-KEY-CentOS-6<br>[root@localhost ~]#<br><a href="http://10.6.4.36/CentOS-6.5/" target="_blank" rel="external">http://10.6.4.36/CentOS-6.5/</a></p>
<p>[root@localhost ~]# yum -y install syslinux<br>[root@localhost ~]# cp /usr/share/syslinux/pxelinux.0 /var/lib/tftpboot/<br>[root@localhost ~]# cp -a /var/www/html/CentOS-6.5/isolinux/* /var/lib/tftpboot/<br>[root@localhost ~]# ls /var/lib/tftpboot/<br>boot.cat  grub.conf   isolinux.bin  memtest     splash.jpg  vesamenu.c32<br>boot.msg  initrd.img  isolinux.cfg  pxelinux.0  TRANS.TBL   vmlinuz<br>[root@localhost ~]# mkdir -p /var/lib/tftpboot/pxelinux.cfg<br>[root@localhost ~]# cp /var/www/html/CentOS-6.5/isolinux/isolinux.cfg /var/lib/tftpboot/pxelinux.cfg/default<br>[root@localhost ~]# </p>
<p>[root@localhost ~]# grub-crypt<br>Password:<br>Retype password:<br>$6$7xeJ5moFJ1sV2KjE$dpQVjz.hxeTFxydJM2yw7d/EXdoaATJ2Tt5wP1lXwwAicp3L4fFY4PWfOAUYkz1rpKV1lSD7g5zDoX0/W1MT1.<br>[root@localhost ~]# </p>
<p>[root@localhost ~]# mkdir /var/www/html/ks_config<br>[root@localhost ~]# vim /var/www/html/ks_config/CentOS-6.5-ks.cfg</p>
<h1 id="Kickstart-Configurator-for-CentOS-6-5-by-jinyan"><a href="#Kickstart-Configurator-for-CentOS-6-5-by-jinyan" class="headerlink" title="Kickstart Configurator for CentOS 6.5 by jinyan"></a>Kickstart Configurator for CentOS 6.5 by jinyan</h1><p>install<br>url –url=”<a href="http://192.168.3.3/CentOS-6.5/" target="_blank" rel="external">http://192.168.3.3/CentOS-6.5/</a>“<br>text<br>lang en_US.UTF-8<br>keyboard us<br>zerombr<br>bootloader –location=mbr –driveorder=sda –append=”crashkernel=auto rhgb quiet”<br>network –onboot yes –device eth0 –bootproto dhcp –noipv6<br>timezone –utc Asia/Shanghai<br>authconfig –enableshadow –passalgo=sha512<br>rootpw  –iscrypted $6$7xeJ5moFJ1sV2KjE$dpQVjz.hxeTFxydJM2yw7d/EXdoaATJ2Tt5wP1lXwwAicp3L4fFY4PWfOAUYkz1rpKV1lSD7g5zDoX0/W1MT1.<br>clearpart –all –initlabel<br>part /boot –fstype=ext4 –asprimary –size=200<br>part swap –size=2048<br>part / –fstype=ext4 –grow –asprimary –size=200<br>firstboot –disable<br>selinux –disabled<br>firewall –disabled<br>logging –level=info<br>reboot<br>%packages<br>@base<br>@core<br>@debugging<br>@basic-desktop<br>@desktop-debugging<br>@desktop-platform<br>@directory-client<br>@fonts<br>@general-desktop<br>@graphical-admin-tools<br>@input-methods<br>@internet-applications<br>@internet-browser<br>@java-platform<br>@legacy-x<br>@network-file-system-client<br>@office-suite<br>@print-client<br>@remote-desktop-clients<br>@server-platform<br>@server-policy<br>@workstation-policy<br>@x11<br>mtools<br>pax<br>oddjob<br>wodim<br>sgpio<br>genisoimage<br>device-mapper-persistent-data<br>abrt-gui<br>samba-winbind<br>certmonger<br>pam_krb5<br>krb5-workstation<br>libXmu<br>%post<br>wget -O /tmp/optimization.sh <a href="http://192.168.3.3/ks_config/optimization.sh" target="_blank" rel="external">http://192.168.3.3/ks_config/optimization.sh</a> &amp;&gt;/dev/null<br>/bin/sh /tmp/optimization.sh<br>%end</p>
<p>[root@localhost ~]# cp /var/lib/tftpboot/pxelinux.cfg/default /var/lib/tftpboot/pxelinux.cfg/defaultbak<br>[root@localhost ~]# &gt;/var/lib/tftpboot/pxelinux.cfg/default<br>[root@localhost ~]# chmod 644 /var/lib/tftpboot/pxelinux.cfg/default<br>[root@localhost ~]# vim /var/lib/tftpboot/pxelinux.cfg/default<br>default ks<br>prompt 0</p>
<p>label ks<br>  kernel vmlinuz<br>  append initrd=initrd.img ks=<a href="http://192.168.3.3/ks_config/CentOS-6.5-ks.cfg" target="_blank" rel="external">http://192.168.3.3/ks_config/CentOS-6.5-ks.cfg</a></p>
<h1 id="append-initrd-initrd-img-ks-http-192-168-3-3-ks-config-CentOS-6-7-ks-cfg-ksdevice-eth0"><a href="#append-initrd-initrd-img-ks-http-192-168-3-3-ks-config-CentOS-6-7-ks-cfg-ksdevice-eth0" class="headerlink" title="append initrd=initrd.img ks=http://192.168.3.3/ks_config/CentOS-6.7-ks.cfg ksdevice=eth0"></a>append initrd=initrd.img ks=<a href="http://192.168.3.3/ks_config/CentOS-6.7-ks.cfg" target="_blank" rel="external">http://192.168.3.3/ks_config/CentOS-6.7-ks.cfg</a> ksdevice=eth0</h1><h1 id="ksdevice-eth0"><a href="#ksdevice-eth0" class="headerlink" title="ksdevice=eth0"></a>ksdevice=eth0</h1><p>[root@localhost ~]# vim /var/www/html/ks_config/optimization.sh</p>
<p>#!/bin/bash</p>
<p>##############################################################</p>
<h1 id="File-Name-var-www-html-ks-config-optimization-sh"><a href="#File-Name-var-www-html-ks-config-optimization-sh" class="headerlink" title="File Name: /var/www/html/ks_config/optimization.sh"></a>File Name: /var/www/html/ks_config/optimization.sh</h1><h1 id="Version-V1-0"><a href="#Version-V1-0" class="headerlink" title="Version: V1.0"></a>Version: V1.0</h1><h1 id="Author-jinyan"><a href="#Author-jinyan" class="headerlink" title="Author: jinyan"></a>Author: jinyan</h1><h1 id="Organization-sanyuanempire"><a href="#Organization-sanyuanempire" class="headerlink" title="Organization: sanyuanempire"></a>Organization: sanyuanempire</h1><h1 id="Created-Time-2016-04-27-12-02-08"><a href="#Created-Time-2016-04-27-12-02-08" class="headerlink" title="Created Time : 2016-04-27 12:02:08"></a>Created Time : 2016-04-27 12:02:08</h1><h1 id="Description-Linux-system-initialization"><a href="#Description-Linux-system-initialization" class="headerlink" title="Description: Linux system initialization"></a>Description: Linux system initialization</h1><p>##############################################################</p>
<p>. /etc/init.d/functions</p>
<h1 id="Defined-result-function"><a href="#Defined-result-function" class="headerlink" title="Defined result function"></a>Defined result function</h1><p>function Msg(){<br>        if [ $? -eq 0 ];then<br>          action “$1” /bin/true<br>        else<br>          action “$1” /bin/false<br>        fi<br>}</p>
<h1 id="Defined-OPEN-FILES-Functions"><a href="#Defined-OPEN-FILES-Functions" class="headerlink" title="Defined OPEN FILES Functions"></a>Defined OPEN FILES Functions</h1><p>function openfiles(){<br>        [ -f “/etc/security/limits.conf” ] &amp;&amp; {<br>        echo ‘*  -  nofile  65535’ &gt;&gt; /etc/security/limits.conf<br>        Msg “open files”<br>        }<br>}</p>
<h1 id="Defined-System-Startup-Services-Functions"><a href="#Defined-System-Startup-Services-Functions" class="headerlink" title="Defined System Startup Services Functions"></a>Defined System Startup Services Functions</h1><p>function boot(){<br>        for jinyan in <code>chkconfig --list|grep &quot;3:on&quot;|awk &#39;{print $1}&#39;|grep -vE &quot;crond|network|rsyslog|sshd|sysstat&quot;</code><br>          do<br>           chkconfig $jinyan off<br>        done<br>        Msg “BOOT config”<br>}</p>
<h1 id="Defined-Time-Synchronization-Functions"><a href="#Defined-Time-Synchronization-Functions" class="headerlink" title="Defined Time Synchronization Functions"></a>Defined Time Synchronization Functions</h1><p>function Time(){<br>        echo “#time sync by jinyan at $(date +%F)” &gt;&gt;/var/spool/cron/root<br>        echo ‘<em>/5 </em> <em> </em> * /usr/sbin/ntpdate -u 192.168.3.3 &amp;&gt;/dev/null’ &gt;&gt;/var/spool/cron/root<br>        Msg “Time Synchronization”<br>}</p>
<h1 id="Defined-main-Functions"><a href="#Defined-main-Functions" class="headerlink" title="Defined main Functions"></a>Defined main Functions</h1><p>function main(){<br>        openfiles<br>       boot<br>        Time<br>}</p>
<p>main</p>
<p>Ip=192.168.3.3<br>Port=80<br>ConfigDir=ks_config</p>
<h1 id="Judge-Http-server-is-ok"><a href="#Judge-Http-server-is-ok" class="headerlink" title="Judge Http server is ok?"></a>Judge Http server is ok?</h1><p>PortNum=<code>nmap $Ip  -p $Port 2&gt;/dev/null|grep open|wc -l</code><br>[ $PortNum -lt 1 ] &amp;&amp; {<br>        echo “Http server is bad!”<br>        exit 1<br>}</p>
<h1 id="Defined-IP-function"><a href="#Defined-IP-function" class="headerlink" title="Defined IP function"></a>Defined IP function</h1><p>function ConfigIP(){<br>        Suffix=<code>ifconfig eth0|awk -F &quot;[ .]+&quot; &#39;NR==2 {print $6}&#39;</code><br>        cat &gt;/etc/sysconfig/network-scripts/ifcfg-eth0 &lt;&lt;-END<br>        DEVICE=eth0<br>        TYPE=Ethernet<br>        ONBOOT=yes<br>        NM_CONTROLLED=yes<br>        BOOTPROTO=none<br>        IPADDR=10.0.0.$Suffix<br>        PREFIX=24<br>        GATEWAY=10.0.0.2<br>        DNS1=10.0.0.2<br>        DEFROUTE=yes<br>        IPV4_FAILURE_FATAL=yes<br>        IPV6INIT=no<br>        NAME=”System eth0”<br>        END<br>        Msg “config eth0”<br>}</p>
<h1 id="Defined-Yum-source-Functions"><a href="#Defined-Yum-source-Functions" class="headerlink" title="Defined Yum source Functions"></a>Defined Yum source Functions</h1><p>function yum(){<br>        YumDir=/etc/yum.repos.d<br>        [ -f “$YumDir/CentOS-Base.repo” ] &amp;&amp; cp $YumDir/CentOS-Base.repo{,.ori}<br>        wget -O $YumDir/CentOS-Base.repo <a href="http://$Ip:$Port/$ConfigDir/CentOS-Base.repo" target="_blank" rel="external">http://$Ip:$Port/$ConfigDir/CentOS-Base.repo</a> &amp;&gt;/dev/null &amp;&amp;\<br>        wget -O $YumDir/epel.repo <a href="http://$Ip:$Port/$ConfigDir/epel.repo" target="_blank" rel="external">http://$Ip:$Port/$ConfigDir/epel.repo</a> &amp;&gt;/dev/null &amp;&amp;\<br>        Msg “YUM source”<br>}</p>
<h1 id="Defined-Hide-the-system-version-number-Functions"><a href="#Defined-Hide-the-system-version-number-Functions" class="headerlink" title="Defined Hide the system version number Functions"></a>Defined Hide the system version number Functions</h1><p>function HideVersion(){<br>        [ -f “/etc/issue” ] &amp;&amp; &gt;/etc/issue<br>        Msg “Hide issue”<br>        [ -f “/etc/issue.net” ] &amp;&amp; &gt; /etc/issue.net<br>        Msg “Hide issue.net”<br>}</p>
<h1 id="Defined-Kernel-parameters-Functions"><a href="#Defined-Kernel-parameters-Functions" class="headerlink" title="Defined Kernel parameters Functions"></a>Defined Kernel parameters Functions</h1><p>function kernel(){<br>        KernelDir=/etc<br>        [ -f “$KernelDir/sysctl.conf” ] &amp;&amp; /bin/mv $KernelDir/sysctl.conf{,.ori}<br>        wget -O $KernelDir/sysctl.conf <a href="http://$Ip:$Port/$ConfigDir/sysctl.conf" target="_blank" rel="external">http://$Ip:$Port/$ConfigDir/sysctl.conf</a> &amp;&gt;/dev/null<br>        Msg “Kernel config”<br>}</p>
<h1 id="Defined-main-Functions-1"><a href="#Defined-main-Functions-1" class="headerlink" title="Defined main Functions"></a>Defined main Functions</h1><p>function main(){<br>        ConfigIP<br>        yum<br>        HideVersion<br>        openfiles<br>        kernel<br>        boot<br>        Time<br>}</p>
<p>main</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/12/15/CentOS-6-x-KickStart/" data-id="ciwpxfwfx000f4zcylbl3vb7g" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-CentOS-6-x-Cobbler" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/15/CentOS-6-x-Cobbler/" class="article-date">
  <time datetime="2016-12-15T03:28:43.000Z" itemprop="datePublished">2016-12-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/15/CentOS-6-x-Cobbler/">CentOS 6.x Cobbler</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>环境：CentOS6.5 64位</p>
<p>关闭防火墙：<br>service iptables stop （临时关闭）<br>chkconfig iptables off （重启后生效）</p>
<p>关闭SELINUX<br>vim /etc/selinux/config<br>SELINUX=disabled</p>
<p>ssh 登录慢<br>vim /etc/ssh/sshd_config<br>UseDNS no<br>/etc/init.d/sshd restart</p>
<p>修改主机名<br>vim /etc/sysconfig/network<br>NETWORKING=yes<br>HOSTNAME=cobbler</p>
<p>rpm -ivh <a href="http://download.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm" target="_blank" rel="external">http://download.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm</a><br>yum clean all<br>yum makecache<br>yum repolist</p>
<p>安装SecureCRT<br>yum -y install lrzsz</p>
<p>安装配置VNC<br>yum -y install tigervnc-server<br>更改配置<br>vim /etc/sysconfig/vncservers<br>VNCSERVERS=”0:root”<br>VNCSERVERARGS[0]=”-geometry 1024x768”<br>设置密码<br>vncpasswd<br>service vncserver start<br>开机启动<br>chkconfig –level 345 vncserver on</p>
<p>NTP<br>yum install ntp -y<br>chkconfig ntpd on<br>chkconfig –list ntpd<br>vim /etc/ntp.conf<br>server 202.120.2.101 prefer<br>service ntpd start<br>ntpstat</p>
<p>双网卡<br>eth0<br>IP地址：10.6.4.3<br>子网掩码：255.255.255.0<br>网关：10.6.4.1<br>[root@cobbler ~]# cat /etc/sysconfig/network-scripts/ifcfg-eth0<br>DEVICE=eth0<br>BOOTPROTO=none<br>HWADDR=82:70:08:d9:98:db<br>NM_CONTROLLED=yes<br>ONBOOT=yes<br>TYPE=Ethernet<br>UUID=”11a6993c-4574-45a7-baf4-eccee247503c”<br>IPADDR=10.6.4.3<br>NETMASK=255.255.255.0<br>DNS2=61.177.7.1<br>GATEWAY=10.6.4.1<br>DNS1=223.5.5.5<br>IPV6INIT=no<br>USERCTL=no<br>[root@cobbler ~]#<br>vim /etc/sysconfig/network-scripts/ifcfg-eth0<br>DEVICE=”eth0”<br>BOOTPROTO=none<br>NM_CONTROLLED=”yes”<br>ONBOOT=”yes”<br>TYPE=”Ethernet”<br>IPADDR=10.6.4.3<br>PREFIX=24<br>GATEWAY=10.6.4.1<br>DNS1=61.177.7.1<br>DOMAIN=223.5.5.5<br>DEFROUTE=yes<br>IPV4_FAILURE_FATAL=yes<br>IPV6INIT=no<br>NAME=”System eth0”<br>HWADDR=82:70:08:d9:98:db</p>
<p>eth1<br>IP地址：192.168.3.3<br>子网掩码：255.255.255.0<br>[root@cobbler ~]# cat /etc/sysconfig/network-scripts/ifcfg-eth1<br>DEVICE=eth1<br>TYPE=Ethernet<br>UUID=99530563-ca29-441b-bfe2-3299357c2170<br>ONBOOT=yes<br>NM_CONTROLLED=yes<br>BOOTPROTO=none<br>IPADDR=192.168.3.3<br>NETMASK=255.255.255.0<br>DNS2=61.177.7.1<br>DNS1=223.5.5.5<br>IPV6INIT=no<br>USERCTL=no<br>HWADDR=3A:E4:4B:3F:BE:9D<br>PREFIX=24<br>DEFROUTE=yes<br>IPV4_FAILURE_FATAL=yes<br>NAME=”System eth1”<br>[root@cobbler ~]#<br>vim /etc/sysconfig/network-scripts/ifcfg-eth1<br>DEVICE=”eth1”<br>BOOTPROTO=none<br>NM_CONTROLLED=”yes”<br>ONBOOT=”yes”<br>TYPE=”Ethernet”<br>IPADDR=192.168.3.3<br>PREFIX=24<br>DNS1=61.177.7.1<br>DOMAIN=223.5.5.5<br>DEFROUTE=yes<br>IPV4_FAILURE_FATAL=yes<br>IPV6INIT=no<br>NAME=”System eth1”</p>
<p>安装XenServer Tools<br>快照</p>
<p>安装cobbler<br>yum -y install cobbler<br>yum install -y tftp-server xinetd dhcp httpd rsync pykickstart  debmirror python-ctypes cman<br>service cobblerd start</p>
<p>设置http服务<br>配置httpd配置文件<br>vim /etc/httpd/conf/httpd.conf<br>ServerName 127.0.0.1:80</p>
<p>安装mod_wsgi<br>yum -y install mod_wsgi<br>vim /etc/httpd/conf.d/wsgi.conf<br>LoadModule  wsgi_module modules/mod_wsgi.so</p>
<p>启动http服务<br>service httpd start<br>chkconfig httpd on</p>
<p>设置tftp服务<br>vim /etc/xinetd.d/tftp<br>disable = no</p>
<p>设置rsync服务<br>vim /etc/xinetd.d/rsync<br>disable = no<br>启动rsync<br>service xinetd start</p>
<p>配置cobbler相关参数<br>vim /etc/debmirror.conf<br>  //注释掉下面两句：</p>
<p>#@dists=”sid”;</p>
<p>#@arches=”i386”;</p>
<p>配置cobbler主配置文件<br>在开启cobbler服务之前，需要修改一些配置文件，在修改配置文件之前最好做一些备份<br>cp /etc/cobbler/settings /etc/cobbler/settingsbak<br>vim /etc/cobbler/settings<br>server:192.168.3.3</p>
<p>#server设置的IP为cobbler服务器指定的地址<br>next_server:192.168.3.3</p>
<p>#next_server是DHCP/PXE网络引导文件被下载的TFTP服务器的IP，这里我们和server设置为同一个IP<br>pxe_just_once:1</p>
<p>#为了防止误重装系统，可以做如下修改，PXE安装只允许一次，防止误操作</p>
<p>生成cobbler安装系统的root初始密码<br>openssl passwd -1 -salt ‘random-phrase-here’’yanjin’</p>
<p>#将得到的字符串加到setting的配置文件中”刚才得到的字符串”修改<br>vim /etc/cobbler/settings<br>default_password_crypted: “$1$random-p$RaMolYuxr4D4mKkRWlYC8.”<br>manage_rsync: 1</p>
<p>#对rsync进行管理<br>manage_dhcp: 1</p>
<p>#对dhcp进行管理</p>
<p>对cobbler管理dhcp的模板修改<br>修改模板文件 /etc/cobbler/dhcp.template 此文件是cobbler管理dhcp的模板，确保dhcp分配的地址和cobbler在同一网段，对于此文件，我们做如下部分的修改：<br>cp /etc/cobbler/dhcp.template /etc/cobbler/dhcp.templatebak<br>vim /etc/cobbler/dhcp.template<br>subnet 192.168.3.0 netmask 255.255.255.0 {<br>     option routers             192.168.3.3;<br>     option domain-name-servers 223.5.5.5;<br>     option subnet-mask         255.255.255.0;<br>     range dynamic-bootp        192.168.3.6 192.168.3.99;</p>
<pre><code>default-lease-time         21600;
max-lease-time             43200;
next-server                $next_server;
class &quot;pxeclients&quot; {
     match if substring (option vendor-class-identifier, 0, 9) = &quot;PXEClient&quot;;
     if option pxe-system-type = 00:02 {
             filename &quot;ia64/elilo.efi&quot;;
     } else if option pxe-system-type = 00:06 {
             filename &quot;grub/grub-x86.efi&quot;;
     } else if option pxe-system-type = 00:07 {
             filename &quot;grub/grub-x86_64.efi&quot;;
     } else {
             filename &quot;pxelinux.0&quot;;
     }
}
</code></pre><p>}</p>
<p>NAT<br>vim /etc/sysctl.conf</p>
<h1 id="net-ipv4-ip-forward-0"><a href="#net-ipv4-ip-forward-0" class="headerlink" title="net.ipv4.ip_forward = 0"></a>net.ipv4.ip_forward = 0</h1><p>net.ipv4.ip_forward = 1<br>sysctl -p</p>
<p>iptables -F<br>iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE<br>iptables -t filter -A FORWARD -i eth0 -o eth1 -j ACCEPT<br>iptables -t filter -A FORWARD -i eth1 -o eth0 -j ACCEPT<br>service iptables save</p>
<p>指定DHCP服务的网络接口<br>vim /etc/sysconfig/dhcpd<br>DHCPDARGS=eth1</p>
<p>加载部分缺失的boot-loaders<br>service cobblerd restart<br>cobbler get-loaders</p>
<p>#如果该步骤无法执行可以将文件下载下来保存到/var/lib/cobbler/loads/中</p>
<p>启动cobbler服务<br>执行dhcpd测试dhcp服务器配置是否正确<br>chkconfig dhcpd on<br>chkconfig cobblerd on<br>service cobblerd restart<br>cobbler sync</p>
<p>#同步配置文件到dhcp服务器中</p>
<p>#如果出现错误时bug，重新启动一遍cobbler即可<br>service dhcpd start</p>
<p>配置cobbler相关服务启动脚本<br>vim /etc/rc.d/init.d/cobbler</p>
<p>#!/bin/sh</p>
<h1 id="chkconfig-80-90"><a href="#chkconfig-80-90" class="headerlink" title="chkconfig: - 80 90"></a>chkconfig: - 80 90</h1><h1 id="description-cobbler"><a href="#description-cobbler" class="headerlink" title="description:cobbler"></a>description:cobbler</h1><p>case $1 in<br>start)<br>/etc/init.d/httpd start<br>/etc/init.d/xinetd start<br>/etc/init.d/dhcpd start<br>/etc/init.d/cobblerd start<br>;;<br>stop)<br>/etc/init.d/httpd stop<br>/etc/init.d/xinetd stop<br>/etc/init.d/dhcpd stop<br>/etc/init.d/cobblerd stop<br>;;<br>restart)<br>/etc/init.d/httpd restart<br>/etc/init.d/xinetd restart<br>/etc/init.d/dhcpd restart<br>/etc/init.d/cobblerd restart<br>;;<br>status)<br>/etc/init.d/httpd status<br>/etc/init.d/xinetd status<br>/etc/init.d/dhcpd status<br>/etc/init.d/cobblerd status<br>;;<br>sync)<br>cobbler sync<br>;;<br>*)<br>echo “Input error,please in put  ‘start|stop|restart|status|sync’!”;<br>exit 2&gt;&amp;1 &gt;/dev/null &amp;<br>;;<br>esac</p>
<p>添加脚本的执行权限<br>chmod +x /etc/rc.d/init.d/cobbler<br>chkconfig cobbler on<br>service cobbler restart<br>cobbler check</p>
<p>挂载镜像<br>mount /dev/cdrom /media/<br>cobbler import –path=/media –name=ubuntu12.04 –breed=ubuntu<br><strong><em> TASK COMPLETE </em></strong><br>cobbler list<br>du -sh /var/www/cobbler/ks_mirror/ubuntu12.04<br>cp /var/lib/cobbler/kickstarts/sample.seed /var/lib/cobbler/kickstarts/sample.seedbak<br>vim /var/lib/cobbler/kickstarts/sample.seed<br>d-i mirror/country string manual<br>d-i mirror/protocol string http<br>d-i mirror/http/hostname string 192.168.3.3<br>d-i mirror/http/directory string /cobbler/ks_mirror/ubuntu12.04<br>d-i mirror/http/proxy string <a href="http://192.168.3.3/" target="_blank" rel="external">http://192.168.3.3/</a></p>
<p>cobbler sync<br>service cobbler restart</p>
<p>cat /var/lib/cobbler/kickstarts/sample.seed</p>
<h1 id="Mostly-based-on-the-Ubuntu-installation-guide"><a href="#Mostly-based-on-the-Ubuntu-installation-guide" class="headerlink" title="Mostly based on the Ubuntu installation guide"></a>Mostly based on the Ubuntu installation guide</h1><h1 id="https-help-ubuntu-com-12-04-installation-guide"><a href="#https-help-ubuntu-com-12-04-installation-guide" class="headerlink" title="https://help.ubuntu.com/12.04/installation-guide/"></a><a href="https://help.ubuntu.com/12.04/installation-guide/" target="_blank" rel="external">https://help.ubuntu.com/12.04/installation-guide/</a></h1><h1 id="Preseeding-only-locale-sets-language-country-and-locale"><a href="#Preseeding-only-locale-sets-language-country-and-locale" class="headerlink" title="Preseeding only locale sets language, country and locale."></a>Preseeding only locale sets language, country and locale.</h1><p>d-i debian-installer/locale string en_US</p>
<h1 id="Keyboard-selection"><a href="#Keyboard-selection" class="headerlink" title="Keyboard selection."></a>Keyboard selection.</h1><h1 id="Disable-automatic-interactive-keymap-detection"><a href="#Disable-automatic-interactive-keymap-detection" class="headerlink" title="Disable automatic (interactive) keymap detection."></a>Disable automatic (interactive) keymap detection.</h1><p>d-i console-setup/ask_detect boolean false<br>d-i keyboard-configuration/layoutcode string us<br>d-i keyboard-configuration/variantcode string</p>
<h1 id="netcfg-will-choose-an-interface-that-has-link-if-possible-This-makes-it"><a href="#netcfg-will-choose-an-interface-that-has-link-if-possible-This-makes-it" class="headerlink" title="netcfg will choose an interface that has link if possible. This makes it"></a>netcfg will choose an interface that has link if possible. This makes it</h1><h1 id="skip-displaying-a-list-if-there-is-more-than-one-interface"><a href="#skip-displaying-a-list-if-there-is-more-than-one-interface" class="headerlink" title="skip displaying a list if there is more than one interface."></a>skip displaying a list if there is more than one interface.</h1><p>#set $myhostname = $getVar(‘hostname’,$getVar(‘name’,’cobbler’)).replace(“_”,”-“)<br>d-i netcfg/choose_interface select auto<br>d-i netcfg/get_hostname string $myhostname</p>
<h1 id="If-non-free-firmware-is-needed-for-the-network-or-other-hardware-you-can"><a href="#If-non-free-firmware-is-needed-for-the-network-or-other-hardware-you-can" class="headerlink" title="If non-free firmware is needed for the network or other hardware, you can"></a>If non-free firmware is needed for the network or other hardware, you can</h1><h1 id="configure-the-installer-to-always-try-to-load-it-without-prompting-Or"><a href="#configure-the-installer-to-always-try-to-load-it-without-prompting-Or" class="headerlink" title="configure the installer to always try to load it, without prompting. Or"></a>configure the installer to always try to load it, without prompting. Or</h1><h1 id="change-to-false-to-disable-asking"><a href="#change-to-false-to-disable-asking" class="headerlink" title="change to false to disable asking."></a>change to false to disable asking.</h1><h1 id="d-i-hw-detect-load-firmware-boolean-true"><a href="#d-i-hw-detect-load-firmware-boolean-true" class="headerlink" title="d-i hw-detect/load_firmware boolean true"></a>d-i hw-detect/load_firmware boolean true</h1><h1 id="NTP-Time-Setup"><a href="#NTP-Time-Setup" class="headerlink" title="NTP/Time Setup"></a>NTP/Time Setup</h1><p>d-i time/zone string US/Eastern<br>d-i clock-setup/utc boolean true<br>d-i clock-setup/ntp boolean true<br>d-i clock-setup/ntp-server  string ntp.ubuntu.com</p>
<h1 id="Setup-the-installation-source"><a href="#Setup-the-installation-source" class="headerlink" title="Setup the installation source"></a>Setup the installation source</h1><p>d-i mirror/country string manual<br>d-i mirror/protocol string http<br>d-i mirror/http/hostname string 192.168.3.3<br>d-i mirror/http/directory string /cobbler/ks_mirror/ubuntu12.04<br>d-i mirror/http/proxy string <a href="http://192.168.3.3/" target="_blank" rel="external">http://192.168.3.3/</a></p>
<h1 id="d-i-mirror-http-hostname-string-http-server"><a href="#d-i-mirror-http-hostname-string-http-server" class="headerlink" title="d-i mirror/http/hostname string $http_server"></a>d-i mirror/http/hostname string $http_server</h1><h1 id="d-i-mirror-http-directory-string-install-source-directory"><a href="#d-i-mirror-http-directory-string-install-source-directory" class="headerlink" title="d-i mirror/http/directory string $install_source_directory"></a>d-i mirror/http/directory string $install_source_directory</h1><h1 id="d-i-mirror-http-proxy-string"><a href="#d-i-mirror-http-proxy-string" class="headerlink" title="d-i mirror/http/proxy string"></a>d-i mirror/http/proxy string</h1><p>#set $os_v = $getVar(‘os_version’,’’)</p>
<p>#if $os_v and $os_v.lower()[0] &gt; ‘p’</p>
<h1 id="Required-at-least-for-12-10"><a href="#Required-at-least-for-12-10" class="headerlink" title="Required at least for 12.10+"></a>Required at least for 12.10+</h1><p>d-i live-installer/net-image string <a href="http://$http_server/cobbler/links/$distro_name/install/filesystem.squashfs" target="_blank" rel="external">http://$http_server/cobbler/links/$distro_name/install/filesystem.squashfs</a></p>
<p>#end if</p>
<h1 id="Suite-to-install"><a href="#Suite-to-install" class="headerlink" title="Suite to install."></a>Suite to install.</h1><h1 id="d-i-mirror-suite-string-precise"><a href="#d-i-mirror-suite-string-precise" class="headerlink" title="d-i mirror/suite string precise"></a>d-i mirror/suite string precise</h1><h1 id="d-i-mirror-udeb-suite-string-precise"><a href="#d-i-mirror-udeb-suite-string-precise" class="headerlink" title="d-i mirror/udeb/suite string precise"></a>d-i mirror/udeb/suite string precise</h1><h1 id="Components-to-use-for-loading-installer-components-optional"><a href="#Components-to-use-for-loading-installer-components-optional" class="headerlink" title="Components to use for loading installer components (optional)."></a>Components to use for loading installer components (optional).</h1><p>#d-i mirror/udeb/components multiselect main, restricted</p>
<h1 id="Disk-Partitioning"><a href="#Disk-Partitioning" class="headerlink" title="Disk Partitioning"></a>Disk Partitioning</h1><h1 id="Use-LVM-and-wipe-out-anything-that-already-exists"><a href="#Use-LVM-and-wipe-out-anything-that-already-exists" class="headerlink" title="Use LVM, and wipe out anything that already exists"></a>Use LVM, and wipe out anything that already exists</h1><p>d-i partman/choose_partition select finish<br>d-i partman/confirm boolean true<br>d-i partman/confirm_nooverwrite boolean true<br>d-i partman-auto/method string lvm<br>d-i partman-lvm/device_remove_lvm boolean true<br>d-i partman-lvm/confirm boolean true<br>d-i partman-lvm/confirm_nooverwrite boolean true<br>d-i partman-md/device_remove_md boolean true<br>d-i partman-partitioning/confirm_write_new_label boolean true</p>
<h1 id="You-can-choose-one-of-the-three-predefined-partitioning-recipes"><a href="#You-can-choose-one-of-the-three-predefined-partitioning-recipes" class="headerlink" title="You can choose one of the three predefined partitioning recipes:"></a>You can choose one of the three predefined partitioning recipes:</h1><h1 id="atomic-all-files-in-one-partition"><a href="#atomic-all-files-in-one-partition" class="headerlink" title="- atomic: all files in one partition"></a>- atomic: all files in one partition</h1><h1 id="home-separate-home-partition"><a href="#home-separate-home-partition" class="headerlink" title="- home:   separate /home partition"></a>- home:   separate /home partition</h1><h1 id="multi-separate-home-usr-var-and-tmp-partitions"><a href="#multi-separate-home-usr-var-and-tmp-partitions" class="headerlink" title="- multi:  separate /home, /usr, /var, and /tmp partitions"></a>- multi:  separate /home, /usr, /var, and /tmp partitions</h1><p>d-i partman-auto/choose_recipe select atomic</p>
<h1 id="If-you-just-want-to-change-the-default-filesystem-from-ext3-to-something"><a href="#If-you-just-want-to-change-the-default-filesystem-from-ext3-to-something" class="headerlink" title="If you just want to change the default filesystem from ext3 to something"></a>If you just want to change the default filesystem from ext3 to something</h1><h1 id="else-you-can-do-that-without-providing-a-full-recipe"><a href="#else-you-can-do-that-without-providing-a-full-recipe" class="headerlink" title="else, you can do that without providing a full recipe."></a>else, you can do that without providing a full recipe.</h1><h1 id="d-i-partman-default-filesystem-string-ext4"><a href="#d-i-partman-default-filesystem-string-ext4" class="headerlink" title="d-i partman/default_filesystem string ext4"></a>d-i partman/default_filesystem string ext4</h1><h1 id="root-account-and-password"><a href="#root-account-and-password" class="headerlink" title="root account and password"></a>root account and password</h1><p>d-i passwd/root-login boolean true<br>d-i passwd/root-password-crypted password $default_password_crypted</p>
<h1 id="skip-creation-of-a-normal-user-account"><a href="#skip-creation-of-a-normal-user-account" class="headerlink" title="skip creation of a normal user account."></a>skip creation of a normal user account.</h1><p>d-i passwd/make-user boolean false</p>
<h1 id="You-can-choose-to-install-restricted-and-universe-software-or-to-install"><a href="#You-can-choose-to-install-restricted-and-universe-software-or-to-install" class="headerlink" title="You can choose to install restricted and universe software, or to install"></a>You can choose to install restricted and universe software, or to install</h1><h1 id="software-from-the-backports-repository"><a href="#software-from-the-backports-repository" class="headerlink" title="software from the backports repository."></a>software from the backports repository.</h1><h1 id="d-i-apt-setup-restricted-boolean-true"><a href="#d-i-apt-setup-restricted-boolean-true" class="headerlink" title="d-i apt-setup/restricted boolean true"></a>d-i apt-setup/restricted boolean true</h1><h1 id="d-i-apt-setup-universe-boolean-true"><a href="#d-i-apt-setup-universe-boolean-true" class="headerlink" title="d-i apt-setup/universe boolean true"></a>d-i apt-setup/universe boolean true</h1><h1 id="d-i-apt-setup-backports-boolean-true"><a href="#d-i-apt-setup-backports-boolean-true" class="headerlink" title="d-i apt-setup/backports boolean true"></a>d-i apt-setup/backports boolean true</h1><h1 id="Uncomment-this-if-you-don’t-want-to-use-a-network-mirror"><a href="#Uncomment-this-if-you-don’t-want-to-use-a-network-mirror" class="headerlink" title="Uncomment this if you don’t want to use a network mirror."></a>Uncomment this if you don’t want to use a network mirror.</h1><h1 id="d-i-apt-setup-use-mirror-boolean-false"><a href="#d-i-apt-setup-use-mirror-boolean-false" class="headerlink" title="d-i apt-setup/use_mirror boolean false"></a>d-i apt-setup/use_mirror boolean false</h1><h1 id="Select-which-update-services-to-use-define-the-mirrors-to-be-used"><a href="#Select-which-update-services-to-use-define-the-mirrors-to-be-used" class="headerlink" title="Select which update services to use; define the mirrors to be used."></a>Select which update services to use; define the mirrors to be used.</h1><h1 id="Values-shown-below-are-the-normal-defaults"><a href="#Values-shown-below-are-the-normal-defaults" class="headerlink" title="Values shown below are the normal defaults."></a>Values shown below are the normal defaults.</h1><h1 id="d-i-apt-setup-services-select-multiselect-security"><a href="#d-i-apt-setup-services-select-multiselect-security" class="headerlink" title="d-i apt-setup/services-select multiselect security"></a>d-i apt-setup/services-select multiselect security</h1><h1 id="d-i-apt-setup-security-host-string-security-ubuntu-com"><a href="#d-i-apt-setup-security-host-string-security-ubuntu-com" class="headerlink" title="d-i apt-setup/security_host string security.ubuntu.com"></a>d-i apt-setup/security_host string security.ubuntu.com</h1><h1 id="d-i-apt-setup-security-path-string-ubuntu"><a href="#d-i-apt-setup-security-path-string-ubuntu" class="headerlink" title="d-i apt-setup/security_path string /ubuntu"></a>d-i apt-setup/security_path string /ubuntu</h1><p>$SNIPPET(‘preseed_apt_repo_config’)</p>
<h1 id="Enable-deb-src-lines"><a href="#Enable-deb-src-lines" class="headerlink" title="Enable deb-src lines"></a>Enable deb-src lines</h1><h1 id="d-i-apt-setup-local0-source-boolean-true"><a href="#d-i-apt-setup-local0-source-boolean-true" class="headerlink" title="d-i apt-setup/local0/source boolean true"></a>d-i apt-setup/local0/source boolean true</h1><h1 id="URL-to-the-public-key-of-the-local-repository-you-must-provide-a-key-or"><a href="#URL-to-the-public-key-of-the-local-repository-you-must-provide-a-key-or" class="headerlink" title="URL to the public key of the local repository; you must provide a key or"></a>URL to the public key of the local repository; you must provide a key or</h1><h1 id="apt-will-complain-about-the-unauthenticated-repository-and-so-the"><a href="#apt-will-complain-about-the-unauthenticated-repository-and-so-the" class="headerlink" title="apt will complain about the unauthenticated repository and so the"></a>apt will complain about the unauthenticated repository and so the</h1><h1 id="sources-list-line-will-be-left-commented-out"><a href="#sources-list-line-will-be-left-commented-out" class="headerlink" title="sources.list line will be left commented out"></a>sources.list line will be left commented out</h1><h1 id="d-i-apt-setup-local0-key-string-http-local-server-key"><a href="#d-i-apt-setup-local0-key-string-http-local-server-key" class="headerlink" title="d-i apt-setup/local0/key string http://local.server/key"></a>d-i apt-setup/local0/key string <a href="http://local.server/key" target="_blank" rel="external">http://local.server/key</a></h1><h1 id="By-default-the-installer-requires-that-repositories-be-authenticated"><a href="#By-default-the-installer-requires-that-repositories-be-authenticated" class="headerlink" title="By default the installer requires that repositories be authenticated"></a>By default the installer requires that repositories be authenticated</h1><h1 id="using-a-known-gpg-key-This-setting-can-be-used-to-disable-that"><a href="#using-a-known-gpg-key-This-setting-can-be-used-to-disable-that" class="headerlink" title="using a known gpg key. This setting can be used to disable that"></a>using a known gpg key. This setting can be used to disable that</h1><h1 id="authentication-Warning-Insecure-not-recommended"><a href="#authentication-Warning-Insecure-not-recommended" class="headerlink" title="authentication. Warning: Insecure, not recommended."></a>authentication. Warning: Insecure, not recommended.</h1><h1 id="d-i-debian-installer-allow-unauthenticated-boolean-true"><a href="#d-i-debian-installer-allow-unauthenticated-boolean-true" class="headerlink" title="d-i debian-installer/allow_unauthenticated boolean true"></a>d-i debian-installer/allow_unauthenticated boolean true</h1><h1 id="Individual-additional-packages-to-install"><a href="#Individual-additional-packages-to-install" class="headerlink" title="Individual additional packages to install"></a>Individual additional packages to install</h1><h1 id="wget-is-REQUIRED-otherwise-quite-a-few-things-won’t-work"><a href="#wget-is-REQUIRED-otherwise-quite-a-few-things-won’t-work" class="headerlink" title="wget is REQUIRED otherwise quite a few things won’t work"></a>wget is REQUIRED otherwise quite a few things won’t work</h1><h1 id="later-in-the-build-like-late-command-scripts"><a href="#later-in-the-build-like-late-command-scripts" class="headerlink" title="later in the build (like late-command scripts)"></a>later in the build (like late-command scripts)</h1><p>d-i pkgsel/include string ntp ssh wget</p>
<h1 id="Use-the-following-option-to-add-additional-boot-parameters-for-the"><a href="#Use-the-following-option-to-add-additional-boot-parameters-for-the" class="headerlink" title="Use the following option to add additional boot parameters for the"></a>Use the following option to add additional boot parameters for the</h1><h1 id="installed-system-if-supported-by-the-bootloader-installer"><a href="#installed-system-if-supported-by-the-bootloader-installer" class="headerlink" title="installed system (if supported by the bootloader installer)."></a>installed system (if supported by the bootloader installer).</h1><h1 id="Note-options-passed-to-the-installer-will-be-added-automatically"><a href="#Note-options-passed-to-the-installer-will-be-added-automatically" class="headerlink" title="Note: options passed to the installer will be added automatically."></a>Note: options passed to the installer will be added automatically.</h1><p>d-i debian-installer/add-kernel-opts string $kernel_options_post</p>
<h1 id="Avoid-that-last-message-about-the-install-being-complete"><a href="#Avoid-that-last-message-about-the-install-being-complete" class="headerlink" title="Avoid that last message about the install being complete."></a>Avoid that last message about the install being complete.</h1><p>d-i finish-install/reboot_in_progress note</p>
<h2 id="Figure-out-if-we’re-kickstarting-a-system-or-a-profile"><a href="#Figure-out-if-we’re-kickstarting-a-system-or-a-profile" class="headerlink" title="Figure out if we’re kickstarting a system or a profile"></a>Figure out if we’re kickstarting a system or a profile</h2><p>#if $getVar(‘system_name’,’’) != ‘’</p>
<p>#set $what = “system”</p>
<p>#else</p>
<p>#set $what = “profile”</p>
<p>#end if</p>
<h1 id="This-first-command-is-run-as-early-as-possible-just-after-preseeding-is-read"><a href="#This-first-command-is-run-as-early-as-possible-just-after-preseeding-is-read" class="headerlink" title="This first command is run as early as possible, just after preseeding is read."></a>This first command is run as early as possible, just after preseeding is read.</h1><h1 id="d-i-preseed-early-command-string-command"><a href="#d-i-preseed-early-command-string-command" class="headerlink" title="d-i preseed/early_command string [command]"></a>d-i preseed/early_command string [command]</h1><p>d-i preseed/early_command string wget -O- \<br>   <a href="http://$http_server/cblr/svc/op/script/$what/$name/?script=preseed_early_default" target="_blank" rel="external">http://$http_server/cblr/svc/op/script/$what/$name/?script=preseed_early_default</a> | \<br>   /bin/sh -s</p>
<h1 id="This-command-is-run-immediately-before-the-partitioner-starts-It-may-be"><a href="#This-command-is-run-immediately-before-the-partitioner-starts-It-may-be" class="headerlink" title="This command is run immediately before the partitioner starts. It may be"></a>This command is run immediately before the partitioner starts. It may be</h1><h1 id="useful-to-apply-dynamic-partitioner-preseeding-that-depends-on-the-state"><a href="#useful-to-apply-dynamic-partitioner-preseeding-that-depends-on-the-state" class="headerlink" title="useful to apply dynamic partitioner preseeding that depends on the state"></a>useful to apply dynamic partitioner preseeding that depends on the state</h1><h1 id="of-the-disks-which-may-not-be-visible-when-preseed-early-command-runs"><a href="#of-the-disks-which-may-not-be-visible-when-preseed-early-command-runs" class="headerlink" title="of the disks (which may not be visible when preseed/early_command runs)."></a>of the disks (which may not be visible when preseed/early_command runs).</h1><h1 id="d-i-partman-early-command"><a href="#d-i-partman-early-command" class="headerlink" title="d-i partman/early_command \"></a>d-i partman/early_command \</h1><h1 id="string-debconf-set-partman-auto-disk-“-list-devices-disk-head-n1-”"><a href="#string-debconf-set-partman-auto-disk-“-list-devices-disk-head-n1-”" class="headerlink" title="string debconf-set partman-auto/disk “\$(list-devices disk | head -n1)”"></a>string debconf-set partman-auto/disk “\$(list-devices disk | head -n1)”</h1><h1 id="This-command-is-run-just-before-the-install-finishes-but-when-there-is"><a href="#This-command-is-run-just-before-the-install-finishes-but-when-there-is" class="headerlink" title="This command is run just before the install finishes, but when there is"></a>This command is run just before the install finishes, but when there is</h1><h1 id="still-a-usable-target-directory-You-can-chroot-to-target-and-use-it"><a href="#still-a-usable-target-directory-You-can-chroot-to-target-and-use-it" class="headerlink" title="still a usable /target directory. You can chroot to /target and use it"></a>still a usable /target directory. You can chroot to /target and use it</h1><h1 id="directly-or-use-the-apt-install-and-in-target-commands-to-easily-install"><a href="#directly-or-use-the-apt-install-and-in-target-commands-to-easily-install" class="headerlink" title="directly, or use the apt-install and in-target commands to easily install"></a>directly, or use the apt-install and in-target commands to easily install</h1><h1 id="packages-and-run-commands-in-the-target-system"><a href="#packages-and-run-commands-in-the-target-system" class="headerlink" title="packages and run commands in the target system."></a>packages and run commands in the target system.</h1><h1 id="d-i-preseed-late-command-string-command"><a href="#d-i-preseed-late-command-string-command" class="headerlink" title="d-i preseed/late_command string [command]"></a>d-i preseed/late_command string [command]</h1><p>d-i preseed/late_command string wget -O- \<br>   <a href="http://$http_server/cblr/svc/op/script/$what/$name/?script=preseed_late_default" target="_blank" rel="external">http://$http_server/cblr/svc/op/script/$what/$name/?script=preseed_late_default</a> | \<br>   chroot /target /bin/sh -s<br>[root@cobbler ~]# </p>
<p>[root@cobbler ~]# mount /dev/cdrom /var/www/html/os/CentOS_6.5-86_64<br>mount: block device /dev/xvdd is write-protected, mounting read-only<br>[root@cobbler ~]# ls /var/www/html/os/CentOS_6.5-86_64<br>CentOS_BuildTag  isolinux                  RPM-GPG-KEY-CentOS-Debug-6<br>EFI              Packages                  RPM-GPG-KEY-CentOS-Security-6<br>EULA             RELEASE-NOTES-en-US.html  RPM-GPG-KEY-CentOS-Testing-6<br>GPL              repodata                  TRANS.TBL<br>images           RPM-GPG-KEY-CentOS-6<br>[root@cobbler ~]#<br>导入系统镜像到cobbler中<br>执行以下语句将镜像挂载到cobbler中<br>[root@cobbler ~]# cobbler import –path=/var/www/html/os/CentOS_6.5-86_64 –name=CentOS_6.5-86_64 –arch=x86_64<br>task started: 2016-06-06_150723_import<br>task started (id=Media import, time=Mon Jun  6 15:07:23 2016)<br>Found a candidate signature: breed=redhat, version=rhel6<br>Found a matching signature: breed=redhat, version=rhel6<br>Adding distros from path /var/www/cobbler/ks_mirror/CentOS_6.5-86_64-x86_64:<br>creating new distro: CentOS_6.5-86_64-x86_64<br>trying symlink: /var/www/cobbler/ks_mirror/CentOS_6.5-86_64-x86_64 -&gt; /var/www/cobbler/links/CentOS_6.5-86_64-x86_64<br>creating new profile: CentOS_6.5-86_64-x86_64<br>associating repos<br>checking for rsync repo(s)<br>checking for rhn repo(s)<br>checking for yum repo(s)<br>starting descent into /var/www/cobbler/ks_mirror/CentOS_6.5-86_64-x86_64 for CentOS_6.5-86_64-x86_64<br>processing repo at : /var/www/cobbler/ks_mirror/CentOS_6.5-86_64-x86_64<br>need to process repo/comps: /var/www/cobbler/ks_mirror/CentOS_6.5-86_64-x86_64<br>looking for /var/www/cobbler/ks_mirror/CentOS_6.5-86_64-x86_64/repodata/<em>comps</em>.xml<br>Keeping repodata as-is :/var/www/cobbler/ks_mirror/CentOS_6.5-86_64-x86_64/repodata<br><strong><em> TASK COMPLETE </em></strong><br>[root@cobbler ~]# </p>
<p>#其中安装源的name即为安装时显示的名称，arch目前支持x86|x86_64|ia64这三种完成后会出现以下提示：associating  kickstarts<strong><em> TASK COMPLETE </em></strong><br>比较大小<br>最后可以通过比较两个文件的大小来判断导入是否正常：<br>[root@cobbler ~]# du -sh /var/www/cobbler/ks_mirror/CentOS_6.5-86_64-x86_64<br>4.2G    /var/www/cobbler/ks_mirror/CentOS_6.5-86_64-x86_64<br>[root@cobbler ~]# du -sh /var/www/html/os/CentOS_6.5-86_64<br>4.2G    /var/www/html/os/CentOS_6.5-86_64<br>[root@cobbler ~]</p>
<p>重新导入<br>重新导入之前需要将原来的删除，执行以下命令：<br>cobbler remove -name=[CentOS_6.5-86_64]</p>
<p>cobbler WEB服务<br>yum -y install cobbler-web<br>vim /etc/cobbler/modules.conf<br>module = authn_configfile</p>
<p>#修改认证方式为密码文件类型<br>htdigest /etc/cobbler/users.digest “Cobbler” cobbler</p>
<p>#添加cobbler用户，提示输入2遍密码确认</p>
<p>cobbler sync</p>
<p>#/输出<strong><em> TASK COMPLETE </em></strong> 表示配置无错误<br>/etc/init.d/httpd restart<br>service cobbler restart<br>cobbler check<br><a href="http://10.6.4.3/cobbler_web" target="_blank" rel="external">http://10.6.4.3/cobbler_web</a><br><a href="http://192.168.3.3/cobbler_web" target="_blank" rel="external">http://192.168.3.3/cobbler_web</a></p>
<p>[root@cobbler ~]# vim /var/lib/cobbler/kickstarts/default.ks</p>
<h1 id="kickstart-template-for-Fedora-8-and-later"><a href="#kickstart-template-for-Fedora-8-and-later" class="headerlink" title="kickstart template for Fedora 8 and later."></a>kickstart template for Fedora 8 and later.</h1><h1 id="includes-end-blocks"><a href="#includes-end-blocks" class="headerlink" title="(includes %end blocks)"></a>(includes %end blocks)</h1><h1 id="do-not-use-with-earlier-distros"><a href="#do-not-use-with-earlier-distros" class="headerlink" title="do not use with earlier distros"></a>do not use with earlier distros</h1><p>#platform=x86, AMD64, or Intel EM64T</p>
<h1 id="System-authorization-information"><a href="#System-authorization-information" class="headerlink" title="System authorization information"></a>System authorization information</h1><p>auth  –useshadow  –enablemd5</p>
<h1 id="System-bootloader-configuration"><a href="#System-bootloader-configuration" class="headerlink" title="System bootloader configuration"></a>System bootloader configuration</h1><p>bootloader –location=mbr</p>
<h1 id="Partition-clearing-information"><a href="#Partition-clearing-information" class="headerlink" title="Partition clearing information"></a>Partition clearing information</h1><p>clearpart –all –initlabel<br>part /boot –fstype=ext4 –asprimary –size=200<br>part swap –size=2048<br>part / –fstype=ext4 –grow –asprimary –size=200</p>
<h1 id="Use-text-mode-install"><a href="#Use-text-mode-install" class="headerlink" title="Use text mode install"></a>Use text mode install</h1><p>text</p>
<h1 id="Firewall-configuration"><a href="#Firewall-configuration" class="headerlink" title="Firewall configuration"></a>Firewall configuration</h1><p>firewall –disabled</p>
<h1 id="Run-the-Setup-Agent-on-first-boot"><a href="#Run-the-Setup-Agent-on-first-boot" class="headerlink" title="Run the Setup Agent on first boot"></a>Run the Setup Agent on first boot</h1><p>firstboot –disable</p>
<h1 id="System-keyboard"><a href="#System-keyboard" class="headerlink" title="System keyboard"></a>System keyboard</h1><p>keyboard us</p>
<h1 id="System-language"><a href="#System-language" class="headerlink" title="System language"></a>System language</h1><p>lang en_US</p>
<h1 id="Use-network-installation"><a href="#Use-network-installation" class="headerlink" title="Use network installation"></a>Use network installation</h1><p>url –url=$tree</p>
<h1 id="If-any-cobbler-repo-definitions-were-referenced-in-the-kickstart-profile-include-them-here"><a href="#If-any-cobbler-repo-definitions-were-referenced-in-the-kickstart-profile-include-them-here" class="headerlink" title="If any cobbler repo definitions were referenced in the kickstart profile, include them here."></a>If any cobbler repo definitions were referenced in the kickstart profile, include them here.</h1><p>$yum_repo_stanza</p>
<h1 id="Network-information"><a href="#Network-information" class="headerlink" title="Network information"></a>Network information</h1><p>$SNIPPET(‘network_config’)</p>
<h1 id="Reboot-after-installation"><a href="#Reboot-after-installation" class="headerlink" title="Reboot after installation"></a>Reboot after installation</h1><p>reboot</p>
<p>#Root password<br>rootpw –iscrypted $default_password_crypted</p>
<h1 id="SELinux-configuration"><a href="#SELinux-configuration" class="headerlink" title="SELinux configuration"></a>SELinux configuration</h1><p>selinux –disabled</p>
<h1 id="Do-not-configure-the-X-Window-System"><a href="#Do-not-configure-the-X-Window-System" class="headerlink" title="Do not configure the X Window System"></a>Do not configure the X Window System</h1><p>skipx</p>
<h1 id="System-timezone"><a href="#System-timezone" class="headerlink" title="System timezone"></a>System timezone</h1><p>timezone  Asia/Shanghai</p>
<h1 id="Install-OS-instead-of-upgrade"><a href="#Install-OS-instead-of-upgrade" class="headerlink" title="Install OS instead of upgrade"></a>Install OS instead of upgrade</h1><p>install</p>
<h1 id="Clear-the-Master-Boot-Record"><a href="#Clear-the-Master-Boot-Record" class="headerlink" title="Clear the Master Boot Record"></a>Clear the Master Boot Record</h1><p>zerombr</p>
<h1 id="Allow-anaconda-to-partition-the-system-as-needed"><a href="#Allow-anaconda-to-partition-the-system-as-needed" class="headerlink" title="Allow anaconda to partition the system as needed"></a>Allow anaconda to partition the system as needed</h1><h1 id="autopart"><a href="#autopart" class="headerlink" title="autopart"></a>autopart</h1><p>%pre<br>$SNIPPET(‘log_ks_pre’)<br>$SNIPPET(‘kickstart_start’)<br>$SNIPPET(‘pre_install_network_config’)</p>
<h1 id="Enable-installation-monitoring"><a href="#Enable-installation-monitoring" class="headerlink" title="Enable installation monitoring"></a>Enable installation monitoring</h1><p>$SNIPPET(‘pre_anamon’)<br>%end</p>
<p>%packages<br>@base<br>@core<br>@debugging<br>@basic-desktop<br>@desktop-debugging<br>@desktop-platform<br>@directory-client<br>@fonts<br>@general-desktop<br>@graphical-admin-tools<br>@input-methods<br>@internet-applications<br>@internet-browser<br>@java-platform<br>@legacy-x<br>@network-file-system-client<br>@office-suite<br>@print-client<br>@remote-desktop-clients<br>@server-platform<br>@server-policy<br>@workstation-policy<br>@x11<br>$SNIPPET(‘func_install_if_enabled’)<br>%end</p>
<p>%post –nochroot<br>$SNIPPET(‘log_ks_post_nochroot’)<br>%end</p>
<p>%post<br>$SNIPPET(‘log_ks_post’)</p>
<h1 id="Start-yum-configuration"><a href="#Start-yum-configuration" class="headerlink" title="Start yum configuration"></a>Start yum configuration</h1><p>$yum_config_stanza</p>
<h1 id="End-yum-configuration"><a href="#End-yum-configuration" class="headerlink" title="End yum configuration"></a>End yum configuration</h1><p>$SNIPPET(‘post_install_kernel_options’)<br>$SNIPPET(‘post_install_network_config’)<br>$SNIPPET(‘func_register_if_enabled’)<br>$SNIPPET(‘download_config_files’)<br>$SNIPPET(‘koan_environment’)<br>$SNIPPET(‘redhat_register’)<br>$SNIPPET(‘cobbler_register’)</p>
<h1 id="Enable-post-install-boot-notification"><a href="#Enable-post-install-boot-notification" class="headerlink" title="Enable post-install boot notification"></a>Enable post-install boot notification</h1><p>$SNIPPET(‘post_anamon’)</p>
<h1 id="Start-final-steps"><a href="#Start-final-steps" class="headerlink" title="Start final steps"></a>Start final steps</h1><p>$SNIPPET(‘kickstart_done’)</p>
<h1 id="End-final-steps"><a href="#End-final-steps" class="headerlink" title="End final steps"></a>End final steps</h1><p>%end</p>
<p>service cobbler restart<br>cobbler sync<br>cobbler check</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/12/15/CentOS-6-x-Cobbler/" data-id="ciwpxfwfi00074zcymu8v43j3" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-CentOS-6-x-Inotify-Rsync" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/15/CentOS-6-x-Inotify-Rsync/" class="article-date">
  <time datetime="2016-12-15T03:27:36.000Z" itemprop="datePublished">2016-12-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/15/CentOS-6-x-Inotify-Rsync/">CentOS 6.x Inotify+Rsync</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>yum -y install lrzsz</p>
<p>[root@rsync ~]#<br>mount -t nfs 10.6.100.75:/volume1/pacebackup /home/nfs/<br>[root@rsync ~]#<br>[root@rsync ~]#<br>[root@rsync ~]# df -h<br>文件系统              容量  已用  可用 已用%% 挂载点<br>/dev/xvda3            195G  5.8G  180G   4% /<br>tmpfs                 497M  228K  496M   1% /dev/shm<br>/dev/xvda1            194M   29M  156M  16% /boot<br>10.6.100.75:/volume1/pacebackup<br>                      5.5T  4.8T  638G  89% /home/nfs</p>
<p>[root@rsync ~]# vim /etc/sysctl.conf<br>fs.inotify.max_user_watches=99999999</p>
<p>CentOS使用inotify+rsync实时同步<br>inotify是Linux下的一个文件系统事件监控机制（简单说就是用于监控某个文件夹的改动），作为dnotify的有效替代。inotify是一种强大的、细粒度的、异步的机制，它满足各种各样的文件监控需要。在单独使用rsync同步时，每次同步它会把全部的文件读取一遍，而inotify+rsync同步是触发式同步。假设被镜像端IP为10.6.0.106，镜像端IP为10.6.0.220。<br>一、被镜像（同步）端<br>linux内核2.6.13之后就支持inotify了，确认方法：<br>ls /proc/sys/fs/inotify<br>如果有以下三项就支持：<br>max_queued_events max_user_instances max_user_watches<br>安装rsync：<br>yum install rsync -y<br>安装inotify：<br>官网：<a href="https://github.com/rvoicilas/inotify-tools" target="_blank" rel="external">https://github.com/rvoicilas/inotify-tools</a><br>cd /tmp<br>wget –no-check-certificate <a href="http://github.com/downloads/rvoicilas/inotify-tools/inotify-tools-3.14.tar.gz" target="_blank" rel="external">http://github.com/downloads/rvoicilas/inotify-tools/inotify-tools-3.14.tar.gz</a><br>tar -zxvf inotify-tools-3.14.tar.gz<br>cd inotify-tools-3.14<br>./configure<br>make<br>make install<br>默认安装到/usr/local/bin目录。<br>建立rsync密码文件：<br>vim /root/rsync.pass<br>输入密码：<br>123456<br>设置权限为600：<br>chmod 600 /root/rsync.pass<br>创建同步脚本：<br>src=/home/data</p>
<p>vim /root/rsync.sh<br>输入：</p>
<p>#!/bin/bash<br>src=/home/nfs/fir_fs_06/000/000/000<br>src=/home/nfs/fir_fs_06/000/000/016<br>src=/home/nfs/fir_fs_06/000/000/017<br>des=backup@10.6.0.220::rsync<br>/usr/local/bin/inotifywait -mrq –timefmt ‘%d/%m/%y %H:%M’ –format ‘%T %w%f’ \<br>-e modify,delete,create,attrib ${src} \<br>| while read x<br>    do<br>        /usr/bin/rsync -avz –delete –progress $src $des –password-file=/root/rsync.pass &amp;&amp;<br>        echo “$x was rsynced” &gt;&gt; /var/log/rsync.log<br>    done<br>注释：<br>inotifywait<br>-m：保持监听事件。<br>-r：递归查看目录。<br>-q：打印出事件。<br>-e modify,delete,create,attrib：监听写入，删除，创建，属性改变事件。<br>rsync<br>-a：存档模式，相当于使用-rlptgoD。<br>-v：详细模式输出。<br>-z：传输过程中压缩文件。<br>为脚本加执行权限：<br>chmod +x /root/rsync.sh<br>在rc.local加入自启动：<br>echo “/root/rsync.sh” &gt;&gt; /etc/rc.local</p>
<p>ps aux | grep rsync | grep -v grep<br>kill -9<br>[root@rsync ~]# kill -9 7694<br>[root@rsync ~]# ps aux | grep rsync | grep -v grep</p>
<p>/root/rsync.sh &amp;</p>
<p>[root@rsync ~]# cd /home/nfs/fir_fs_06/000/000/016<br>[root@rsync 016]# touch a<br>[root@rsync 016]#</p>
<p>二、镜像（同步）端<br>安装rsync：<br>yum install rsync -y<br>编辑配置文件：<br>vim /etc/rsyncd.conf<br>输入：<br>uid = rsync<br>gid = rsync<br>use chroot = no<br>max connections = 10<br>pid file = /var/run/rsyncd.pid<br>lock file = /var/run/rsync.lock<br>log file = /var/log/rsyncd.log<br>hosts allow = *<br>[rsync]<br>path = /root/pacsrsync/<br>read only = no<br>list = no<br>auth users = backup<br>secrets file = /root/rsync.pass<br>建立密码文件：<br>vim /root/rsync.pass<br>输入：<br>backup:123456<br>格式为“用户名:密码”。<br>设置权限为600：<br>chmod 600 /root/rsync.pass<br>建立保存同步文档的目录：<br>mkdir /home/tzuchi/<br>chown nobody:nobody /home/tzuchi/</p>
<p>chown -R rsync:rsync /root/pacsrsync/<br>后台启动rsync：<br>/usr/bin/rsync –daemon –config=/etc/rsyncd.conf<br>在被镜像端上运行同步脚本：<br>/root/rsync.sh &amp;</p>
<p>日志</p>
<blockquote>
<p>/var/log/rsyncd.log<br>tail -f /var/log/rsyncd.log</p>
</blockquote>
<p>[root@n10 ~]# cd /root/pacsrsync/<br>[root@n10 pacsrsync]# mkdir 016<br>[root@n10 pacsrsync]# chown rsync.rsync 016<br>[root@n10 pacsrsync]# ll<br>总用量 44<br>drwx—— 634 rsync rsync 12288 6月  14 2016 000<br>drwxr-xr-x   2 rsync rsync  4096 6月  13 14:55 001<br>drwx—— 913 rsync rsync 20480 6月  14 2016 016<br>drwx——  16 rsync rsync  4096 6月  13 14:27 262<br>drwxrwxrwx   8 rsync rsync  4096 6月  13 13:26 data<br>[root@n10 pacsrsync]#<br>[root@n10 pacsrsync]# mkdir 017<br>[root@n10 pacsrsync]# chown rsync.rsync 017<br>[root@n10 pacsrsync]# ll<br>总用量 48<br>drwx—— 634 rsync rsync 12288 6月  14 2016 000<br>drwxr-xr-x   2 rsync rsync  4096 6月  13 14:55 001<br>drwx—— 913 rsync rsync 20480 6月  14 2016 016<br>drwxr-xr-x   2 rsync rsync  4096 6月  14 07:24 017<br>drwx——  16 rsync rsync  4096 6月  13 14:27 262<br>drwxrwxrwx   8 rsync rsync  4096 6月  13 13:26 data<br>[root@n10 pacsrsync]#</p>
<p>ps aux | grep rsync | grep -v grep<br>kill -9<br>ps aux | grep rsync | grep -v grep<br>/usr/bin/rsync –daemon –config=/etc/rsyncd.conf</p>
<p>vim /root/rsync.sh</p>
<p>#!/bin/bash<br>inotify_rsync_fun ()<br>{<br>    dir=<code>echo $1 | awk -F&quot;,&quot; &#39;{print $1}&#39;</code><br>    ip=<code>echo $1 | awk -F&quot;,&quot; &#39;{print $2}&#39;</code><br>    des=<code>echo $1 | awk -F&quot;,&quot; &#39;{print $3}&#39;</code><br>    user=<code>echo $1 | awk -F&quot;,&quot; &#39;{print $4}&#39;</code><br>    /usr/local/bin/inotifywait -mrq –timefmt ‘%d/%m/%y %H:%M’ –format ‘%T %w%f’ -e modify,delete,create,attrib ${dir} |while read DATE TIME DIR FILE<br>        do<br>                FILECHAGE=${DIR}${FILE}<br>                /usr/bin/rsync -avz –delete –progress  –password-file=/root/rsync.pass ${dir} ${user}@${ip}::${des} &amp;&amp; echo “At ${TIME} on ${DATE}, file $FILECHAGE was backed up via rsync” &gt;&gt; /var/log/rsync.log<br>        done<br>}<br>count=3</p>
<h1 id="localdir-host-rsync-module-user-of-rsync-module"><a href="#localdir-host-rsync-module-user-of-rsync-module" class="headerlink" title="localdir,host,rsync_module,user of rsync_module,"></a>localdir,host,rsync_module,user of rsync_module,</h1><p>sync1=”/home/nfs/fir_fs_06/000/000/000,10.6.0.220,dir1,backup”<br>sync2=”/home/nfs/fir_fs_06/000/000/016,10.6.0.220,dir2,backup”<br>sync3=”/home/nfs/fir_fs_06/000/000/017,10.6.0.220,dir3,backup”</p>
<p>#############################################################</p>
<p>#main<br>i=0<br>while [ ${i} -lt ${count} ]<br>do<br>    i=<code>expr ${i} + 1</code><br>    tmp=”sync”$i<br>    eval “sync=\$$tmp”<br>    inotify_rsync_fun “$sync” &amp;<br>done</p>
<p>vim /etc/rsyncd.conf<br>uid = rsync<br>gid = rsync<br>use chroot = no<br>max connections = 0<br>pid file = /var/run/rsyncd.pid<br>lock file = /var/run/rsync.lock<br>log file = /var/log/rsyncd.log<br>hosts allow = *</p>
<p>[dir1]<br>path = /root/pacsrsync/<br>comment = rsync from everyone<br>read only = no<br>list = no<br>auth users = backup<br>secrets file = /root/rsync.pass</p>
<p>[dir2]<br>path = /root/pacsrsync/<br>comment = rsync from everyone<br>read only = no<br>list = no<br>auth users = backup<br>secrets file = /root/rsync.pass</p>
<p>[dir3]<br>path = /root/pacsrsync/017/<br>comment = rsync from everyone<br>read only = no<br>list = no<br>auth users = backup<br>secrets file = /root/rsync.pass</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/12/15/CentOS-6-x-Inotify-Rsync/" data-id="ciwpxfwfw000e4zcyvil7c4tg" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-CentOS-6-x-OpenLDAP" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/15/CentOS-6-x-OpenLDAP/" class="article-date">
  <time datetime="2016-12-15T03:26:25.000Z" itemprop="datePublished">2016-12-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/15/CentOS-6-x-OpenLDAP/">CentOS 6.x OpenLDAP</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>yum -y install openldap<em>  db4</em><br>slappasswd<br>cp /usr/share/openldap-servers/slapd.conf.obsolete /etc/openldap/slapd.conf</p>
<p>vim /etc/openldap/slapd.conf<br>access to *<br>    by dn.exact=”gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth” read</p>
<h1 id="by-dn-exact-”cn-Manager-dc-my-domain-dc-com”-read"><a href="#by-dn-exact-”cn-Manager-dc-my-domain-dc-com”-read" class="headerlink" title="by dn.exact=”cn=Manager,dc=my-domain,dc=com” read"></a>by dn.exact=”cn=Manager,dc=my-domain,dc=com” read</h1><pre><code>by dn.exact=&quot;cn=admin,dc=example,dc=com&quot; read
    by * none
</code></pre><p>database    bdb</p>
<h1 id="suffix-“dc-my-domain-dc-com”"><a href="#suffix-“dc-my-domain-dc-com”" class="headerlink" title="suffix        “dc=my-domain,dc=com”"></a>suffix        “dc=my-domain,dc=com”</h1><p>suffix          “dc=example,dc=com”<br>checkpoint    1024 15<br>rootdn          “cn=admin,dc=example,dc=com”</p>
<h1 id="rootdn-“cn-Manager-dc-my-domain-dc-com”"><a href="#rootdn-“cn-Manager-dc-my-domain-dc-com”" class="headerlink" title="rootdn        “cn=Manager,dc=my-domain,dc=com”"></a>rootdn        “cn=Manager,dc=my-domain,dc=com”</h1><h1 id="Cleartext-passwords-especially-for-the-rootdn-should"><a href="#Cleartext-passwords-especially-for-the-rootdn-should" class="headerlink" title="Cleartext passwords, especially for the rootdn, should"></a>Cleartext passwords, especially for the rootdn, should</h1><h1 id="be-avoided-See-slappasswd-8-and-slapd-conf-5-for-details"><a href="#be-avoided-See-slappasswd-8-and-slapd-conf-5-for-details" class="headerlink" title="be avoided.  See slappasswd(8) and slapd.conf(5) for details."></a>be avoided.  See slappasswd(8) and slapd.conf(5) for details.</h1><h1 id="Use-of-strong-authentication-encouraged"><a href="#Use-of-strong-authentication-encouraged" class="headerlink" title="Use of strong authentication encouraged."></a>Use of strong authentication encouraged.</h1><h1 id="rootpw-secret"><a href="#rootpw-secret" class="headerlink" title="rootpw        secret"></a>rootpw        secret</h1><h1 id="rootpw-crypt-ijFYNcSNctBYg"><a href="#rootpw-crypt-ijFYNcSNctBYg" class="headerlink" title="rootpw        {crypt}ijFYNcSNctBYg"></a>rootpw        {crypt}ijFYNcSNctBYg</h1><p>rootpw        yanjin</p>
<p>cp /usr/share/openldap-servers/DB_CONFIG.example  /var/lib/ldap/DB_CONFIG<br>rm -rf /etc/openldap/slapd.d/*<br>service slapd restart<br>chkconfig slapd on<br>chown -R ldap:ldap /var/lib/ldap<br>chown -R ldap:ldap /etc/openldap/<br>slaptest  -f /etc/openldap/slapd.conf -F /etc/openldap/slapd.d<br>chown -R ldap:ldap /etc/openldap/slapd.d<br>service slapd restart<br>useradd ldapuser1<br>passwd ldapuser1<br>yum install migrationtools -y<br>[root@localhost ~]# cd /usr/share/migrationtools/<br>[root@localhost migrationtools]# vim  migrate_common.ph<br>70 行</p>
<h1 id="DEFAULT-MAIL-DOMAIN-“padl-com”"><a href="#DEFAULT-MAIL-DOMAIN-“padl-com”" class="headerlink" title="$DEFAULT_MAIL_DOMAIN = “padl.com”;"></a>$DEFAULT_MAIL_DOMAIN = “padl.com”;</h1><p>$DEFAULT_MAIL_DOMAIN = “example.com”;</p>
<h1 id="Default-base"><a href="#Default-base" class="headerlink" title="Default base"></a>Default base</h1><h1 id="DEFAULT-BASE-“dc-padl-dc-com”"><a href="#DEFAULT-BASE-“dc-padl-dc-com”" class="headerlink" title="$DEFAULT_BASE = “dc=padl,dc=com”;"></a>$DEFAULT_BASE = “dc=padl,dc=com”;</h1><p>$DEFAULT_BASE = “dc=example,dc=com”;</p>
<p>[root@localhost migrationtools]# ./migrate_base.pl &gt; /tmp/base.ldif<br>[root@localhost migrationtools]# ./migrate_passwd.pl  /etc/passwd &gt; /tmp/passwd.ldif<br>[root@localhost migrationtools]# ./migrate_group.pl  /etc/group &gt; /tmp/group.ldif<br>[root@localhost migrationtools]#</p>
<p>ldapadd -x -D “cn=admin,dc=example,dc=com” -W -f /tmp/base.ldif</p>
<p>ldapadd -x -D “cn=admin,dc=example,dc=com” -W -f /tmp/passwd.ldif</p>
<p>ldapadd -x -D “cn=admin,dc=example,dc=com” -W -f /tmp/group.ldif<br>service slapd restart</p>
<p>导入导出<br>LdapAdmin.exe</p>
<p>10.6.0.19<br>389<br>dc=example,dc=com<br>cn=admin,dc=example,dc=com<br>sztzuchi</p>
<p>dc=example,dc=com<br>cn=admin,dc=example,dc=com<br>yanjin</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/12/15/CentOS-6-x-OpenLDAP/" data-id="ciwpxfwg3000j4zcydbmqbime" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-CentOS-6-x-Squid" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/15/CentOS-6-x-Squid/" class="article-date">
  <time datetime="2016-12-15T03:23:48.000Z" itemprop="datePublished">2016-12-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/15/CentOS-6-x-Squid/">CentOS 6.x Squid</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>环境：CentOS6.5 64位</p>
<p>关闭防火墙：<br>service iptables stop （临时关闭）<br>chkconfig iptables off （重启后生效）</p>
<p>关闭SELINUX<br>vim /etc/selinux/config<br>SELINUX=disabled</p>
<p>ssh 登录慢<br>vim /etc/ssh/sshd_config<br>122 UseDNS no<br>/etc/init.d/sshd restart</p>
<p>修改主机名<br>vim /etc/sysconfig/network<br>NETWORKING=yes<br>HOSTNAME=squid</p>
<p>rpm -ivh <a href="http://download.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm" target="_blank" rel="external">http://download.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm</a></p>
<p>cd /etc/yum.repos.d/<br>mv cobbler-config.repo cobbler-config.repobak<br>yum clean all<br>yum makecache<br>yum repolist</p>
<p>安装SecureCRT<br>yum -y install lrzsz</p>
<p>安装配置VNC<br>yum -y install tigervnc-server<br>更改配置<br>vim /etc/sysconfig/vncservers<br>VNCSERVERS=”0:root”<br>VNCSERVERARGS[0]=”-geometry 1024x768”<br>设置密码<br>vncpasswd<br>service vncserver start<br>开机启动<br>chkconfig –level 345 vncserver on</p>
<p>NTP<br>yum install ntp -y<br>chkconfig ntpd on<br>vim /etc/ntp.conf<br>server 202.120.2.101 prefer<br>service ntpd start<br>ntpstat</p>
<p>双网卡<br>eth0<br>IP地址：10.6.0.101<br>子网掩码：255.255.255.0<br>网关：10.6.0.128<br>cat /etc/sysconfig/network-scripts/ifcfg-eth0<br>DEVICE=eth0<br>BOOTPROTO=none<br>HWADDR=9a:58:98:fb:64:93<br>IPV6INIT=yes<br>MTU=1500<br>NM_CONTROLLED=yes<br>ONBOOT=yes<br>TYPE=Ethernet<br>UUID=”8a6cf2c6-50d5-4118-b343-477b0fe0850c”<br>IPADDR=10.6.0.101<br>NETMASK=255.255.255.0<br>DNS2=114.114.114.114<br>GATEWAY=10.6.0.128<br>DNS1=223.5.5.5<br>USERCTL=no</p>
<p>eth1<br>IP地址：192.168.3.3<br>子网掩码：255.255.255.0<br>ifconfig eth1 192.168.3.3 netmask 255.255.255.0<br>cat /etc/sysconfig/network-scripts/ifcfg-eth1<br>DEVICE=eth0<br>BOOTPROTO=none<br>HWADDR=4E:F7:71:1F:2B:77<br>IPV6INIT=yes<br>MTU=1500<br>NM_CONTROLLED=yes<br>ONBOOT=yes<br>TYPE=Ethernet<br>IPADDR=192.168.3.3<br>NETMASK=255.255.255.0<br>DNS2=114.114.114.114<br>DNS1=223.5.5.5<br>USERCTL=no</p>
<p>安装XenServer Tools<br>mount /dev/cdrom /media/<br>cd /media/Linux/<br>./install.sh<br>You should now reboot this Virtual Machine.<br>快照</p>
<p>普通代理 http_port 3128<br>透明代理 http_port 3128 transparent<br>反向代理 http_port 3128 accel vhost vport</p>
<p>去除显示grep进程<br>ps -ef |grep ‘sbin/squid’ | grep -v grep |wc -l</p>
<p>加载系统函数库<br>. /etc/init.d/functions</p>
<p>日期<br>access_$(date +%F).log</p>
<p>使用yum 方式安装<br>yum -y install squid<br>设置开机自启动<br>chkconfig –level 35 squid on<br>在3、5级别上自动运行squid服务</p>
<p>squid服务器的配置文件说明<br>去#号及去空行<br>egrep -v “#|^$” /etc/squid/squid.conf<br>acl manager proto cache_object<br>acl localhost src 127.0.0.1/32 ::1<br>acl to_localhost dst 127.0.0.0/8 0.0.0.0/32 ::1<br>acl SSL_ports port 443<br>acl CONNECT method CONNECT<br>http_access allow manager localhost<br>http_access deny manager<br>http_access deny !Safe_ports<br>http_access deny CONNECT !SSL_ports<br>http_access allow localnet<br>http_access allow localhost<br>http_access deny all<br>http_port 3128<br>coredump_dir /var/spool/squid<br>refresh_pattern ^ftp:           1440    20%     10080<br>refresh_pattern ^gopher:        1440    0%      1440<br>refresh_pattern -i (/cgi-bin/|\?) 0     0%      0<br>refresh_pattern .               0       20%     4320</p>
<p>cp /etc/squid/squid.conf /etc/squid/squid.confbak<br>squid 的主配置文件是 /etc/squid/squid.conf，所有squid的设定都是在这个文件里配置，下面是一些常用的配置选项。<br>vim /etc/squid/squid.conf<br>http_port　3128<br>设置监听的IP与端口号<br>cache_mem 64 MB<br>额外提供给squid使用的内存，squid的内存总占用为 X <em> 10+15+“cache_mem”，其中X为squid的cache占用的容量（以GB为单位）<br>比如下面的cache大小是100M，即0.1GB，则内存总占用为0.1</em>10+15+64=80M，推荐大小为物理内存的1/3-1/2或更多。<br>maximum_object_size 4 MB<br>设置squid磁盘缓存最大文件，超过4M的文件不保存到硬盘<br>minimum_object_size 0 KB<br>设置squid磁盘缓存最小文件<br>maximum_object_size_in_memory 4096 KB<br>设置squid内存缓存最大文件，超过4M的文件不保存到内存<br>cache_dir ufs /var/spool/squid 100 16 256<br>定义squid的cache存放路径 、cache目录容量（单位M）、一级缓存目录数量、二级缓存目录数量<br>logformat combined %&gt;a %ui %un [%tl] “%rm %ru HTTP/%rv” %Hs %h” “%{User-Agent}&gt;h” %Ss:%Sh<br>emulate_httpd_log on<br>log文件日志格式<br>access_log /var/log/squid/access.log combined<br>log文件存放路径和日志格式<br>cache_log /var/log/squid/cache.log<br>设置缓存日志<br>logfile_rotate 60<br>log轮循 60天<br>cache_swap_high 95<br>cache目录使用量大于95%时，开始清理旧的<br>cachecache_swap_low 90<br>cache目录清理到90%时停止。<br>acl localnet src 10.6.0.0/16<br>定义本地网段<br>http_access allow localnet<br>允许本地网段使用<br>http_access deny all<br>拒绝所有<br>visible_hostname squid.sanyuan.tk<br>主机名<br>cache_mgr example@test.com<br>管理员邮箱</p>
<p>普通代理<br>编辑squid 主配置文件/etc/squid/squid.conf<br>vim /etc/squid/squid.conf</p>
<p>acl manager proto cache_object<br>acl localhost src 127.0.0.1/32 ::1<br>acl to_localhost dst 127.0.0.0/8 0.0.0.0/32 ::1<br>acl CONNECT method CONNECT<br>acl localnet src 10.6.0.0/16<br>http_access allow manager localhost<br>http_access deny manager<br>http_access allow localnet<br>http_access allow localhost<br>http_access deny all<br>http_port 3128<br>coredump_dir /var/spool/squid<br>cache_mem 64 MB<br>maximum_object_size 4 MB<br>minimum_object_size 0 KB<br>maximum_object_size_in_memory 4096 KB<br>cache_dir ufs /var/spool/squid 100 16 256<br>access_log /var/log/squid/access.log<br>cache_log /var/log/squid/cache.log<br>emulate_httpd_log on<br>logfile_rotate 60<br>cache_swap_high 95<br>cache_swap_low 90<br>visible_hostname squid.sanyuan.tk<br>cache_mgr yanjin198620@126.com<br>refresh_pattern ^ftp:           1440    20%     10080<br>refresh_pattern ^gopher:        1440    0%      1440<br>refresh_pattern -i (/cgi-bin/|\?) 0     0%      0<br>refresh_pattern .               0       20%     4320</p>
<p>mv /etc/squid/squid.conf /etc/squid/squid.confnormal<br>cp /etc/squid/squid.confnormal /etc/squid/squid.conf</p>
<p>example：<br>http_port 3128<br>cache_mem 64 MB<br>maximum_object_size 4 MB<br>cache_dir ufs /var/spool/squid 100 16 256<br>access_log /var/log/squid/access.log<br>acl localnet src 10.6.0.0/16<br>http_access allow localnet<br>http_access deny all<br>visible_hostname squid.sanyuan.tk<br>cache_mgr mchina_tang@qq.com</p>
<p>检查语法<br>squid -k parse</p>
<p>初始化<br>squid -z</p>
<p>启动Squid<br>/etc/init.d/squid start<br>chkconfig squid on</p>
<p>ps -ef |grep ‘squid’ | grep -v grep</p>
<p>lsof -i :3128</p>
<p>tail -f /var/log/squid/access.log</p>
<p>透明代理<br>vim /etc/squid/squid.conf</p>
<p>acl manager proto cache_object<br>acl localhost src 127.0.0.1/32 ::1<br>acl to_localhost dst 127.0.0.0/8 0.0.0.0/32 ::1<br>acl CONNECT method CONNECT<br>acl localnet src 10.6.0.0/16<br>http_access allow manager localhost<br>http_access deny manager<br>http_access allow localnet<br>http_access allow localhost<br>http_access allow all<br>http_port 3128 transparent<br>coredump_dir /var/spool/squid<br>cache_mem 64 MB<br>maximum_object_size 4 MB<br>minimum_object_size 0 KB<br>maximum_object_size_in_memory 4096 KB<br>cache_dir ufs /var/spool/squid 100 16 256<br>access_log /var/log/squid/access.log<br>cache_log /var/log/squid/cache.log<br>emulate_httpd_log on<br>logfile_rotate 60<br>cache_swap_high 95<br>cache_swap_low 90<br>visible_hostname squid.sanyuan.tk<br>cache_mgr yanjin198620@126.com<br>refresh_pattern ^ftp:           1440    20%     10080<br>refresh_pattern ^gopher:        1440    0%      1440<br>refresh_pattern -i (/cgi-bin/|\?) 0     0%      0<br>refresh_pattern .               0       20%     4320</p>
<p>mv /etc/squid/squid.conf /etc/squid/squid.conftransparent</p>
<p>example：<br>http_port 3128 transparent<br>cache_mem 64 MB<br>maximum_object_size 4 MB<br>cache_dir ufs /var/spool/squid 100 16 256<br>access_log /var/log/squid/access.log<br>acl localnet src 10.6.0.0/16<br>http_access allow localnet<br>http_access deny all<br>visible_hostname squid.sanyuan.tk<br>cache_mgr mchina_tang@qq.com<br>在http_port 3128 后添加transparent 关键字。</p>
<p>reload<br>reload 让上面的配置生效。<br>/etc/init.d/squid reload</p>
<p>检查语法<br>squid -k parse</p>
<p>ps -ef |grep ‘squid’ | grep -v grep</p>
<p>lsof -i :3128</p>
<p>yum -y install dhcp<br>安装DHCP服务<br>cp /etc/dhcp/dhcpd.conf /etc/dhcp/dhcpd.conf.bak<br>备份dhcpd.conf文件<br>vim /etc/dhcp/dhcpd.conf<br>subnet 192.168.3.0 netmask 255.255.255.0 {<br>     option routers             192.168.3.3;<br>     option domain-name-servers 223.5.5.5;<br>     option subnet-mask         255.255.255.0;<br>     range dynamic-bootp        192.168.3.6 192.168.3.99;<br>     default-lease-time         21600;<br>     max-lease-time             43200;<br>     next-server                192.168.3.3;<br>}</p>
<p>指定DHCP服务的网络接口<br>vim /etc/sysconfig/dhcpd<br>DHCPDARGS=eth1</p>
<p>service dhcpd start<br>chkconfig dhcpd on</p>
<p>NAT<br>vim /etc/sysctl.conf<br>7 # net.ipv4.ip_forward = 0<br>net.ipv4.ip_forward = 1<br>sysctl -p</p>
<p>添加iptables规则，把内部的http请求重定向到3128端口<br>清除现有iptables filter 表规则<br>iptables -F<br>保存iptables 设置<br>/etc/init.d/iptables save<br>iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE<br>iptables -t filter -A FORWARD -i eth0 -o eth1 -j ACCEPT<br>iptables -t filter -A FORWARD -i eth1 -o eth0 -j ACCEPT<br>iptables -t nat -I PREROUTING -i eth1 -s 192.168.3.0/24 -p tcp –dport 80 -j REDIRECT –to-port 3128<br>保存<br>/etc/init.d/iptables save</p>
<p>反向代理</p>
<p>vim /etc/squid/squid.conf</p>
<p>acl manager proto cache_object<br>acl localhost src 127.0.0.1/32 ::1<br>http_access allow manager localhost<br>http_access deny manager<br>http_access allow all<br>http_port 80 accel vhost<br>cache_peer 192.168.3.6 parent 80 0 originserver round-robin weight=1<br>cache_peer 10.6.6.200 parent 80 0 originserver round-robin weight=1<br>coredump_dir /var/spool/squid<br>cache_mem 64 MB<br>maximum_object_size 4 MB<br>minimum_object_size 0 KB<br>maximum_object_size_in_memory 4096 KB<br>cache_dir ufs /var/spool/squid 100 16 256<br>access_log /var/log/squid/access.log<br>cache_log /var/log/squid/cache.log<br>emulate_httpd_log on<br>logfile_rotate 60<br>cache_swap_high 95<br>cache_swap_low 90<br>visible_hostname squid.sanyuan.tk<br>cache_mgr yanjin198620@126.com<br>refresh_pattern ^ftp:           1440    20%     10080<br>refresh_pattern ^gopher:        1440    0%      1440<br>refresh_pattern -i (/cgi-bin/|\?) 0     0%      0<br>refresh_pattern .               0       20%     4320</p>
<p>mv /etc/squid/squid.conf /etc/squid/squid.confreverse</p>
<p>example：<br>http_port 80 accel vhost<br>http_access allow all<br>cache_peer 192.168.3.6 parent 80 0 originserver round-robin weight=1<br>cache_peer 192.168.3.9 parent 80 0 originserver round-robin weight=1<br>visible_hostname squid.sanyuan.tk</p>
<p>/etc/init.d/squid restart<br>squid 采用了round-robin，所以客户端的访问将轮询两台web服务器，采用 “Ctrl + F5” 来深度刷新测试。</p>
<p>检查语法<br>squid -k parse</p>
<p>ps -ef |grep ‘squid’ | grep -v grep</p>
<p>lsof -i :80</p>
<p>启用验证</p>
<p>yum -y install mysql*</p>
<p>[root@squid mysql_auth-0.8]# vim Makefile</p>
<p>CC = gcc<br>CFLAGS = -I /usr/include/mysql -L /usr/lib64/mysql -lz -lm<br>LDFLAGS = -lmysqlclient<br>SRC = src<br>OBJS = $(SRC)/mysql_auth.o $(SRC)/confparser.o $(SRC)/mypasswd.o<br>INSTALL = /usr/bin/install<br>CONF = $(SRC)/mysql_auth.conf</p>
<p>all : mysql_auth mypasswd</p>
<p>clean:<br>        rm -rf src/<em>.o </em>.o mysql_auth mypasswd</p>
<p>mysql_auth: $(OBJS)<br>        $(CC) -o $@ $(SRC)/mysql_auth.c $(SRC)/confparser.c $(LDFLAGS) $(CFLAGS)</p>
<p>mypasswd: $(OBJS)<br>        $(CC) -o $@ $(SRC)/mypasswd.c $(SRC)/confparser.c $(LDFLAGS) $(CFLAGS)</p>
<p>install:<br>        $(INSTALL) -o nobody -g nogroup -m 755 mysql_auth /etc/squid/mysql_auth<br>        $(INSTALL) -o root -g root -m 700 mypasswd /usr/local/bin/mypasswd<br>        $(INSTALL) -o nobody -g nogroup -m 600 $(CONF) /etc/squid/mysql_auth.conf<br>        $(INSTALL) -o nobody -g nogroup -m 600 $(CONF) /etc/squid/mysql_auth.conf.default</p>
<p>linux-yanjin:~/mysql_auth-0.8/src # vim define.h</p>
<p>#define CONFIG_FILE “/etc/squid/mysql_auth.conf”</p>
<p>#define VAR_MYSQLD_SOCKET “mysql_socket”</p>
<p>#define DEF_MYSQLD_SOCKET “/var/lib/mysql/mysql.sock”</p>
<p>linux-yanjin:~/mysql_auth-0.8/src # vim mysql_auth.conf<br>mysql_socket   /var/lib/mysql/mysql.sock</p>
<p>[root@squid mysql_auth-0.8]# make<br>gcc -I /usr/include/mysql -L /usr/lib64/mysql -lz -lm   -c -o src/mysql_auth.o src/mysql_auth.c<br>gcc -I /usr/include/mysql -L /usr/lib64/mysql -lz -lm   -c -o src/confparser.o src/confparser.c<br>gcc -I /usr/include/mysql -L /usr/lib64/mysql -lz -lm   -c -o src/mypasswd.o src/mypasswd.c<br>gcc -o mysql_auth src/mysql_auth.c src/confparser.c -lmysqlclient -I /usr/include/mysql -L /usr/lib64/mysql -lz -lm<br>gcc -o mypasswd src/mypasswd.c src/confparser.c -lmysqlclient -I /usr/include/mysql -L /usr/lib64/mysql -lz -lm<br>[root@squid mysql_auth-0.8]# make install<br>/usr/bin/install -o nobody -g nogroup -m 755 mysql_auth /etc/squid/mysql_auth<br>/usr/bin/install -o root -g root -m 700 mypasswd /usr/local/bin/mypasswd<br>/usr/bin/install -o nobody -g nogroup -m 600 src/mysql_auth.conf /etc/squid/mysql_auth.conf<br>/usr/bin/install -o nobody -g nogroup -m 600 src/mysql_auth.conf /etc/squid/mysql_auth.conf.default<br>[root@squid mysql_auth-0.8]# cd scripts/<br>[root@squid scripts]# mysql -u root -pyanjin &lt; create_script<br>[root@squid scripts]# mypasswd yanjin 123<br>Password record ADDED succesfully.<br>[root@squid scripts]#</p>
<p>查看mysql_auth table<br>linux-yanjin:~ # mysql -uroot -pyanjin<br>Welcome to the MySQL monitor.  Commands end with ; or \g.<br>Your MySQL connection id is 13<br>Server version: 5.0.95-Max SUSE MySQL RPM</p>
<p>Type ‘help;’ or ‘\h’ for help. Type ‘\c’ to clear the current input statement.</p>
<p>mysql&gt; use mysql_auth;<br>Database changed<br>mysql&gt; select * from data;<br>+——–+———-+<br>| user   | password |<br>+——–+———-+<br>| yanjin | 123      |<br>+——–+———-+<br>1 row in set (0.00 sec)</p>
<p>查看用戶<br>mysql&gt; select user,host,password from mysql.user;<br>+——–+————–+——————————————-+<br>| user   | host         | password                                  |<br>+——–+————–+——————————————-+<br>| root   | localhost    | <em>4327D690FDFB060004FF99724B03EB7303EFEA76 |<br>| root   | linux-yanjin |                                           |<br>| root   | 127.0.0.1    |                                           |<br>|        | localhost    |                                           |<br>|        | linux-yanjin |                                           |<br>| renjia | localhost    | </em>4327D690FDFB060004FF99724B03EB7303EFEA76 |<br>| squid  | localhost    | *AFD42D37182BDB40880BEF624CC64B0F4A1E35B4 |<br>+——–+————–+——————————————-+<br>7 rows in set (0.00 sec)</p>
<p>允许远程访问<br>mysql&gt; use mysql_auth;<br>Database changed<br>mysql&gt; GRANT ALL ON <em>.</em> TO squid@’%’ IDENTIFIED BY ‘squid’ WITH GRANT OPTION;<br>Query OK, 0 rows affected (0.00 sec)<br>mysql&gt; flush privileges;<br>Query OK, 0 rows affected (0.03 sec)</p>
<p>mysql&gt;</p>
<p>設置mysql_auth文件權限<br>chmod 777 /etc/squid/mysql_auth.conf</p>
<p>四、配置SQUID.conf<br>[root@squid ~]# vim /etc/squid/squid.conf<br>auth_param basic program /etc/squid/mysql_auth<br>auth_param basic children 5<br>auth_param basic realm squid Proxy web server<br>auth_param basic credentialsttl 2 hours<br>acl manager proto cache_object<br>acl localhost src 127.0.0.1/32 ::1<br>acl to_localhost dst 127.0.0.0/8 0.0.0.0/32 ::1<br>acl CONNECT method CONNECT<br>acl localnet src 10.6.0.0/16<br>acl password proxy_auth REQUIRED<br>http_access allow password<br>http_access allow manager localhost<br>http_access deny manager<br>http_access allow localnet<br>http_access allow localhost<br>http_access deny all<br>http_port 3128<br>coredump_dir /var/spool/squid<br>cache_mem 64 MB<br>maximum_object_size 4 MB<br>minimum_object_size 0 KB<br>maximum_object_size_in_memory 4096 KB<br>cache_dir ufs /var/spool/squid 100 16 256<br>access_log /var/log/squid/access.log<br>cache_log /var/log/squid/cache.log<br>emulate_httpd_log on<br>logfile_rotate 60<br>cache_swap_high 95<br>cache_swap_low 90<br>visible_hostname squid.sanyuan.tk<br>cache_mgr yanjin198620@126.com<br>refresh_pattern ^ftp:           1440    20%     10080<br>refresh_pattern ^gopher:        1440    0%      1440<br>refresh_pattern -i (/cgi-bin/|\?) 0     0%      0<br>refresh_pattern .               0       20%     4320<br>[root@squid ~]#</p>
<p>建立cache文件<br>mkdir -p /var/cache/squida<br>mkdir -p /var/cache/squidb<br>mkdir -p /var/cache/squidc<br>chown -R squid:root /var/cache/squida<br>chown -R squid:root /var/cache/squidb<br>chown -R squid:root /var/cache/squidc<br>chmod 777 /var/cache/squida<br>chmod 777 /var/cache/squidb<br>chmod 777 /var/cache/squidc</p>
<p>[root@squid ~]# vim /etc/squid/squid.conf<br>1、MysQL_auth驗證模塊<br>auth_param basic program /etc/squid/mysql_auth<br>auth_param basic children 5<br>auth_param basic realm squid Proxy web server<br>auth_param basic credentialsttl 2 hours</p>
<p>2、訪問控制列表<br>acl password proxy_auth REQUIRED<br>http_access allow password<br>http_access deny all<br>http_access allow manager localhost<br>http_access deny manager<br>http_access deny !Safe_ports<br>http_access deny CONNECT !SSL_ports<br>http_access allow localnet<br>http_access allow localhost</p>
<p>3、驗證有效期<br>authenticate_ttl 2 hour<br>authenticate_ip_ttl 2 hours</p>
<p>4、squid可以使用的記憶體大小<br>cache_mem 256 MB<br>squid磁片替換策略<br>cache_replacement_policy lru<br>squid記憶體替換策略<br>memory_replacement_policy lru</p>
<p>5、緩存容量閥值<br>cache_swap_low 70<br>cache_swap_high 85</p>
<p>6、squid磁片緩存最大檔<br>maximum_object_size 32768 KB<br>squid記憶體緩存最大檔<br>maximum_object_size_in_memory 4096 KB</p>
<p>7、緩存目錄<br>cache_dir ufs /var/cache/squida 7168 16 256<br>cache_dir ufs /var/cache/squidb 7168 16 256<br>cache_dir ufs /var/cache/squidc 7168 16 256</p>
<p>8、HOSTS<br>hosts_file /etc/hosts</p>
<p>9、主機名<br>visible_hostname squid</p>
<p>10、日誌 2124行<br>cache_access_log /var/log/squid/access.log</p>
<p>11、日誌輪詢<br>logfile_rotate 10</p>
<p>12、日誌輸出方式<br>emulate_httpd_log on</p>
<p>[root@squid ~]# /etc/init.d/squid restart<br>Stopping squid: …………….[  OK  ]<br>Starting squid: .[  OK  ]<br>[root@squid ~]#</p>
<p>tail -f /var/log/squid/access.log</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/12/15/CentOS-6-x-Squid/" data-id="ciwpxfwgg000p4zcy8rngiknu" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-CentOS-6-x-SendMail" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/15/CentOS-6-x-SendMail/" class="article-date">
  <time datetime="2016-12-15T03:22:18.000Z" itemprop="datePublished">2016-12-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/15/CentOS-6-x-SendMail/">CentOS 6.x SendMail</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>sendmail是Linux下优秀的邮件系统。今天某个网站需要有发邮件的需求，而服务器安装时没有安装这个，那就开始吧。<br>1、安装</p>
<pre><code>#yum install -y sendmail
#yum install -y sendmail-cf
如果需要SMTP验证就安装并启动saslauthd服务：
# service saslauthd start 
</code></pre><p>2、配置        </p>
<p>(1) 配置Senmail的SMTP认证</p>
<h1 id="vi-etc-mail-sendmail-mc"><a href="#vi-etc-mail-sendmail-mc" class="headerlink" title="vi /etc/mail/sendmail.mc"></a>vi /etc/mail/sendmail.mc</h1><p>dnl TRUST_AUTH_MECH(`EXTERNAL DIGEST-MD5 CRAM-MD5 LOGIN PLAIN’)dnl </p>
<p>dnl define(<code>confAUTH_MECHANISMS’,</code>EXTERNAL GSSAPI DIGEST-MD5 CRAM-MD5 LOGIN PLAIN’)dnl </p>
<p>将上面两行的dnl去掉。在sendmail文件中，dnl表示该行为注释行，是无效的，因此通过去除行首的dnl字符串可以开启相应的设置行。</p>
<p>(2) 设置Sendmail服务的网络访问权限（因为我是直接本机调用所以我没有操作这个步骤）</p>
<p>vi /etc/mail/sendmail.mc</p>
<pre><code>DAEMON_OPTIONS(`Port=smtp,Addr=0.0.0.0, Name=MTA‘)dnl 
</code></pre><p>将127.0.0.1改为0.0.0.0，意思是任何主机都可以访问Sendmail服务。如果仅让某一个网段能够访问到Sendmail服务，将127.0.0.1改为形如192.168.1.0/24的一个特定网段地址。<br>3、生成配置文件</p>
<p>Sendmail的配置文件由m4来生成，m4工具在sendmail-cf包中。如果系统无法识别m4命令，说明sendmail-cf软件包没有安装。</p>
<p>#m4 /etc/mail/sendmail.mc &gt; /etc/mail/sendmail.cf<br>4、启动服务</p>
<p>service sendmail start</p>
<p>service sendmail restart</p>
<p>[root@rsync py]#<br>ps aux | grep sendmail | grep -v grep<br>smmsp     9311  0.0  0.2  78136  2140 ?        Ss   14:27   0:00 sendmail: Queue runner@01:00:00 for /var/spool/clientmqueue<br>root      9324  0.0  0.0 103252   852 pts/0    S+   14:29   0:00 grep sendmail<br>[root@rsync py]# </p>
<p>检查服务是否加入自启行列</p>
<p>[root@rsync py]# chkconfig sendmail on<br>[root@rsync py]# chkconfig –list |grep sendmail<br>sendmail        0:关闭  1:关闭  2:启用  3:启用  4:启用  5:启用  6:关闭<br>[root@rsync py]# </p>
<p>[root@rsync py]#<br>mail -s xxx 455177385@qq.com<br>xxx<br>EOT<br>你可以把当前shell当成编辑器来用，编辑完内容后Ctrl-D结束</p>
<p>echo “mail content”|mail -s test 455177385@qq.com</p>
<p>mail -s test 455177385@qq.com &lt; file #第三种方法，以file的内容为邮件内容发信</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/12/15/CentOS-6-x-SendMail/" data-id="ciwpxfwg9000m4zcyihy0wkxx" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-CentOS-6-x-GlusterFS" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/15/CentOS-6-x-GlusterFS/" class="article-date">
  <time datetime="2016-12-15T03:13:50.000Z" itemprop="datePublished">2016-12-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/15/CentOS-6-x-GlusterFS/">CentOS 6.x GlusterFS</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>一、前言<br>GlusterFS是一个开源的分布式文件系统,于2011年被红帽收购.它具有高扩展性、高性能、高可用性、可横向扩展的弹性特点,无元数据服务器设计使glusterfs没有单点故障隐患，详细介绍请查看官网：www.gluster.org 。<br>二、环境<br>1、系统：<br>Centos 6.5<br>2、部署说明<br>服务端：<br>10.6.0.217<br>10.6.0.218<br>10.6.0.219<br>客户端：<br>10.6.0.215<br>三、部署<br>1、服务端安装：<br>rpm -ivh <a href="http://download.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm" target="_blank" rel="external">http://download.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm</a><br>wget -P /etc/yum.repos.d <a href="https://download.gluster.org/pub/gluster/glusterfs/3.7/3.7.12/CentOS/glusterfs-epel.repo" target="_blank" rel="external">https://download.gluster.org/pub/gluster/glusterfs/3.7/3.7.12/CentOS/glusterfs-epel.repo</a><br>[root@n5 ~]# cd /etc/yum.repos.d/<br>[root@n5 yum.repos.d]# cat glusterfs-epel.repo</p>
<h1 id="Place-this-file-in-your-etc-yum-repos-d-directory"><a href="#Place-this-file-in-your-etc-yum-repos-d-directory" class="headerlink" title="Place this file in your /etc/yum.repos.d/ directory"></a>Place this file in your /etc/yum.repos.d/ directory</h1><p>[glusterfs-epel]<br>name=GlusterFS is a clustered file-system capable of scaling to several petabytes.<br>baseurl=<a href="http://download.gluster.org/pub/gluster/glusterfs/3.7/3.7.12/EPEL.repo/epel-$releasever/$basearch/" target="_blank" rel="external">http://download.gluster.org/pub/gluster/glusterfs/3.7/3.7.12/EPEL.repo/epel-$releasever/$basearch/</a><br>enabled=1<br>skip_if_unavailable=1<br>gpgcheck=1</p>
<h1 id="gpgkey-http-download-gluster-org-pub-gluster-glusterfs-3-7-3-7-12-EPEL-repo-pub-key"><a href="#gpgkey-http-download-gluster-org-pub-gluster-glusterfs-3-7-3-7-12-EPEL-repo-pub-key" class="headerlink" title="gpgkey=http://download.gluster.org/pub/gluster/glusterfs/3.7/3.7.12/EPEL.repo/pub.key"></a>gpgkey=<a href="http://download.gluster.org/pub/gluster/glusterfs/3.7/3.7.12/EPEL.repo/pub.key" target="_blank" rel="external">http://download.gluster.org/pub/gluster/glusterfs/3.7/3.7.12/EPEL.repo/pub.key</a></h1><p>gpgkey=<a href="https://download.gluster.org/pub/gluster/glusterfs/3.7/3.7.12/EPEL.repo/pub.key" target="_blank" rel="external">https://download.gluster.org/pub/gluster/glusterfs/3.7/3.7.12/EPEL.repo/pub.key</a></p>
<p>[glusterfs-noarch-epel]<br>name=GlusterFS is a clustered file-system capable of scaling to several petabytes.<br>baseurl=<a href="http://download.gluster.org/pub/gluster/glusterfs/3.7/3.7.12/EPEL.repo/epel-$releasever/noarch" target="_blank" rel="external">http://download.gluster.org/pub/gluster/glusterfs/3.7/3.7.12/EPEL.repo/epel-$releasever/noarch</a><br>enabled=1<br>skip_if_unavailable=1<br>gpgcheck=1<br>gpgkey=<a href="http://download.gluster.org/pub/gluster/glusterfs/3.7/3.7.12/EPEL.repo/pub.key" target="_blank" rel="external">http://download.gluster.org/pub/gluster/glusterfs/3.7/3.7.12/EPEL.repo/pub.key</a></p>
<p>[glusterfs-source-epel]<br>name=GlusterFS is a clustered file-system capable of scaling to several petabytes. - Source<br>baseurl=<a href="http://download.gluster.org/pub/gluster/glusterfs/3.7/3.7.12/EPEL.repo/epel-$releasever/SRPMS" target="_blank" rel="external">http://download.gluster.org/pub/gluster/glusterfs/3.7/3.7.12/EPEL.repo/epel-$releasever/SRPMS</a><br>enabled=0<br>skip_if_unavailable=1<br>gpgcheck=1</p>
<h1 id="gpgkey-http-download-gluster-org-pub-gluster-glusterfs-3-7-3-7-12-EPEL-repo-pub-key-1"><a href="#gpgkey-http-download-gluster-org-pub-gluster-glusterfs-3-7-3-7-12-EPEL-repo-pub-key-1" class="headerlink" title="gpgkey=http://download.gluster.org/pub/gluster/glusterfs/3.7/3.7.12/EPEL.repo/pub.key"></a>gpgkey=<a href="http://download.gluster.org/pub/gluster/glusterfs/3.7/3.7.12/EPEL.repo/pub.key" target="_blank" rel="external">http://download.gluster.org/pub/gluster/glusterfs/3.7/3.7.12/EPEL.repo/pub.key</a></h1><p>gpgkey=<a href="https://download.gluster.org/pub/gluster/glusterfs/3.7/3.7.12/EPEL.repo/pub.key" target="_blank" rel="external">https://download.gluster.org/pub/gluster/glusterfs/3.7/3.7.12/EPEL.repo/pub.key</a><br>[root@n5 yum.repos.d]#<br>wget -P /etc/yum.repos.d <a href="https://download.gluster.org/pub/gluster/glusterfs/3.7/3.7.12/pub.key" target="_blank" rel="external">https://download.gluster.org/pub/gluster/glusterfs/3.7/3.7.12/pub.key</a><br>[root@n6 ~]# cd -<br>/etc/yum.repos.d<br>[root@n6 yum.repos.d]# scp -r glusterfs-epel.repo pub.key root@n5:/etc/yum.repos.d<br>The authenticity of host ‘n5 (10.6.0.215)’ can’t be established.<br>RSA key fingerprint is 23:92:f4:8f:62:12:e2:31:d2:31:5b:d7:28:f3:58:1f.<br>Are you sure you want to continue connecting (yes/no)? yes<br>Warning: Permanently added ‘n5,10.6.0.215’ (RSA) to the list of known hosts.<br>root@n5’s password:<br>glusterfs-epel.repo                                                                                                                            100% 1257     1.2KB/s   00:00<br>pub.key                                                                                                                                        100% 1732     1.7KB/s   00:00<br>[root@n6 yum.repos.d]#<br>yum clean all<br>rpm –import pub.key<br>yum makecache<br>yum -y install glusterfs glusterfs-server<br>chkconfig glusterd on<br>service glusterd start<br>2、服务端配置：<br>将3个存储节点组成一集群，本文在第一个节点执行，只需要在任意节点执行就OK。<br>[root@n6 ~]# gluster peer probe 10.6.0.216<br>peer probe: success. Probe on localhost not needed<br>[root@n6 ~]# gluster peer probe 10.6.0.217<br>peer probe: success.<br>[root@n6 ~]# gluster peer probe 10.6.0.218<br>peer probe: success.<br>[root@n6 ~]# gluster peer probe 10.6.0.219<br>peer probe: success.<br>查看集群的节点信息：<br>[root@n6 ~]# gluster peer status<br>Number of Peers: 3</p>
<p>Hostname: 10.6.0.217<br>Uuid: f2614374-cc36-4f01-970d-8bae30928451<br>State: Peer in Cluster (Connected)</p>
<p>Hostname: 10.6.0.218<br>Uuid: 3baee195-593a-4d97-9b61-96eb2a7e1778<br>State: Peer in Cluster (Connected)</p>
<p>Hostname: 10.6.0.219<br>Uuid: b342072a-ca38-476c-82b8-21ed28eb5376<br>State: Peer in Cluster (Connected)<br>以/data/gluster为共享目录，创建名为img的卷,副本数为3：<br>mkdir -p /data/gluster<br>[root@n6 ~]# gluster volume create img replica 3 10.6.0.217:/data/gluster 10.6.0.218:/data/gluster 10.6.0.219:/data/gluster force<br>volume create: img: success: please start the volume to access data<br>启动卷：<br>[root@n6 ~]# gluster volume start img<br>volume start: img: success<br>[root@n6 ~]#<br>查看卷状态:<br>[root@n6 ~]# gluster volume info</p>
<p>Volume Name: img<br>Type: Replicate<br>Volume ID: c481f5a9-5dcb-4cb3-9870-0ec57dbc22fb<br>Status: Started<br>Number of Bricks: 1 x 3 = 3<br>Transport-type: tcp<br>Bricks:<br>Brick1: 10.6.0.217:/data/gluster<br>Brick2: 10.6.0.218:/data/gluster<br>Brick3: 10.6.0.219:/data/gluster<br>Options Reconfigured:<br>performance.readdir-ahead: on<br>[root@n6 ~]#<br>3、客户端安装配置：<br>安装：<br>yum -y install glusterfs glusterfs-fuse<br>[root@n5 ~]# mkdir -p /data/img<br>挂载任意一个节点即可<br>[root@n5 ~]# mount -t glusterfs 10.6.0.217:/img /data/img<br>[root@n5 ~]# df -h<br>Filesystem                  Size  Used Avail Use% Mounted on<br>/dev/mapper/vg_n5-LogVol00  3.6T  1.1T  2.4T  31% /<br>tmpfs                       1.9G   68K  1.9G   1% /dev/shm<br>/dev/sda1                   194M   35M  150M  19% /boot<br>cm_processes                1.9G   72M  1.9G   4% /opt/cm-5.1.3/run/cloudera-scm-agent/process<br>10.6.0.217:/img             3.6T  1.4T  2.1T  41% /data/img<br>[root@n5 ~]#<br>mount -t nfs -o mountproto=tcp,vers=3 10.6.0.217:/img /home/nfs （使用NFS挂载，注意远端的rpcbind服务必须开启）<br>echo “10.6.0.217:/img /data/img glusterfs defaults,_netdev 0 0” &gt;&gt; /etc/fstab (开机自动挂载)</p>
<p>安装配置Samba<br>yum install samba samba-client samba-swat -y<br>vim /etc/samba/smb.conf<br>[img]<br>        comment = The img<br>        path = /data/img<br>        browseable = yes<br>        writable = yes<br>useradd smbimg<br>smbpasswd -a smbimg<br>/etc/init.d/smb start<br>/etc/init.d/nmb start<br>service smb status<br>chkconfig smb on</p>
<p>[root@n5 ~]# ll -d /data/img/<br>drwxr-xr-x 4 root root 4096 8月   2 13:56 /data/img/<br>[root@n5 ~]# chown -R smbimg:smbimg /data/img/<br>[root@n5 ~]# ll -d /data/img/<br>drwxr-xr-x 4 smbimg smbimg 4096 8月   2 13:56 /data/img/<br>[root@n5 ~]#<br>[root@n5 ~]# ll /data/img/<br>总用量 0<br>-rwxr–r– 1 smbimg smbimg 0 8月   2 14:08 测试gfs.txt</p>
<p>安装配置FTP<br>yum -y install vsftpd<br>vim /etc/vsftpd/vsftpd.conf<br>chkconfig –level 345 vsftpd on<br>useradd -g ftp -d /data/img/ftpimg -M ftpimg<br>passwd ftpimg<br>chown -R ftpimg /data/img/ftpimg<br>ll -d /data/img/ftpimg<br>drwxr-xr-x 2 ftpimg root 4096 8月   2 14:12 /data/img/ftpimg<br>service vsftpd restart</p>
<p>四、测试<br>1、检查文件正确性<br>dd if=/dev/urandom of=/data/navy bs=1M count=100 # 在挂载客户端生成测试文件<br>cp /data/navy /mnt/  # 文件拷贝到存储上<br>md5sum /data/navy /mnt/navy # 在查看客户端检查文件哈希<br>md5sum /data/gluster/navy # 存储集群的某2个节点上会有此文件，检查其哈希<br>2、宕机测试。使用glusterfs-fuse挂载，即使目标服务器故障，也完全不影响使用。用NFS则要注意挂载选项，否则服务端故障容易导致文件系统halt住而影响服务！</p>
<h1 id="将其中一个节点停止存储服务service-glusterd-stop"><a href="#将其中一个节点停止存储服务service-glusterd-stop" class="headerlink" title="将其中一个节点停止存储服务service glusterd stop"></a>将其中一个节点停止存储服务service glusterd stop</h1><p>service glusterfsd stop# 在挂载客户端删除测试文件<br>rm -fv /mnt/navy# 此时在服务端查看，服务被停止的节点上navy并未被删除。此时启动服务：service glusterd start# 数秒后，navy就被自动删除了。新增文件效果相同！<br>五、运维常用命令：<br>删除卷<br>gluster volume stop img<br>gluster volume delete img<br>将机器移出集群<br>gluster peer detach 10.6.0.217<br>只允许10.6.<em>.</em>的网络访问glusterfs<br>gluster volume set img auth.allow 10.6.<em>.</em></p>
<p>加入新的机器并添加到卷里(由于副本数设置为3,至少要添加3（6、9、12..）台机器)<br>gluster peer probe 10.6.0.212<br>gluster peer probe 10.6.0.213<br>gluster peer probe 10.6.0.216</p>
<p>[root@n3 ~]# mkdir -p /data/gluster<br>gluster volume add-brick img 10.6.0.212:/data/gluster 10.6.0.213:/data/gluster 10.6.0.216:/data/gluster force</p>
<p>[root@n6 ~]# gluster volume add-brick img 10.6.0.212:/data/gluster 10.6.0.213:/data/gluster 10.6.0.216:/data/gluster force<br>volume add-brick: success<br>[root@n6 ~]# gluster volume info</p>
<p>Volume Name: img<br>Type: Distributed-Replicate<br>Volume ID: c481f5a9-5dcb-4cb3-9870-0ec57dbc22fb<br>Status: Started<br>Number of Bricks: 2 x 3 = 6<br>Transport-type: tcp<br>Bricks:<br>Brick1: 10.6.0.217:/data/gluster<br>Brick2: 10.6.0.218:/data/gluster<br>Brick3: 10.6.0.219:/data/gluster<br>Brick4: 10.6.0.212:/data/gluster<br>Brick5: 10.6.0.213:/data/gluster<br>Brick6: 10.6.0.216:/data/gluster<br>Options Reconfigured:<br>performance.readdir-ahead: on<br>[root@n6 ~]#</p>
<p><a href="https://gluster.readthedocs.io/en/latest/Administrator%20Guide/Managing%20Volumes/#rebalancing-volumes" target="_blank" rel="external">https://gluster.readthedocs.io/en/latest/Administrator%20Guide/Managing%20Volumes/#rebalancing-volumes</a><br>均衡卷<br>[root@n6 ~]# gluster volume rebalance img start<br>volume rebalance: img: success: Rebalance on img has been started successfully. Use rebalance status command to check status of the rebalance process.<br>ID: b9d8629a-673d-4db2-8361-bb8e9b65b16b</p>
<p>[root@n6 ~]# gluster volume rebalance img status<br>                                    Node Rebalanced-files          size       scanned      failures       skipped               status  run time in h:m:s</p>
<pre><code> ---------      -----------   -----------   -----------   -----------   -----------         ------------     --------------
 localhost                0        0Bytes             0             0             0          in progress        0:0:17
10.6.0.217                0        0Bytes          1033             0           341          in progress        0:0:16
10.6.0.218                0        0Bytes             0             0             0          in progress        0:0:17
10.6.0.219                0        0Bytes             0             0             0          in progress        0:0:16
10.6.0.212                0        0Bytes             1             0             0          in progress        0:0:17
10.6.0.213                0        0Bytes             0             0             0          in progress        0:0:17
</code></pre><p>volume rebalance: img: success<br>[root@n6 ~]#</p>
<p>[root@n6 ~]# gluster volume status<br>Status of volume: img</p>
<h2 id="Gluster-process-TCP-Port-RDMA-Port-Online-Pid"><a href="#Gluster-process-TCP-Port-RDMA-Port-Online-Pid" class="headerlink" title="Gluster process                             TCP Port  RDMA Port  Online  Pid"></a>Gluster process                             TCP Port  RDMA Port  Online  Pid</h2><p>Brick 10.6.0.217:/data/gluster              49152     0          Y       31557<br>Brick 10.6.0.218:/data/gluster              49152     0          Y       2469<br>Brick 10.6.0.219:/data/gluster              49152     0          Y       12325<br>Brick 10.6.0.212:/data/gluster              49152     0          Y       31261<br>Brick 10.6.0.213:/data/gluster              49152     0          Y       24831<br>Brick 10.6.0.216:/data/gluster              49152     0          Y       28081<br>NFS Server on localhost                     2049      0          Y       28102<br>Self-heal Daemon on localhost               N/A       N/A        Y       28112<br>NFS Server on 10.6.0.217                    2049      0          Y       8257<br>Self-heal Daemon on 10.6.0.217              N/A       N/A        Y       8267<br>NFS Server on 10.6.0.219                    2049      0          Y       26335<br>Self-heal Daemon on 10.6.0.219              N/A       N/A        Y       26344<br>NFS Server on 10.6.0.212                    N/A       N/A        N       N/A<br>Self-heal Daemon on 10.6.0.212              N/A       N/A        Y       31290<br>NFS Server on 10.6.0.213                    2049      0          Y       24852<br>Self-heal Daemon on 10.6.0.213              N/A       N/A        Y       24861<br>NFS Server on 10.6.0.218                    2049      0          Y       9773<br>Self-heal Daemon on 10.6.0.218              N/A       N/A        Y       9782</p>
<h2 id="Task-Status-of-Volume-img"><a href="#Task-Status-of-Volume-img" class="headerlink" title="Task Status of Volume img"></a>Task Status of Volume img</h2><p>Task                 : Rebalance<br>ID                   : b9d8629a-673d-4db2-8361-bb8e9b65b16b<br>Status               : completed           </p>
<p>[root@n6 ~]#</p>
<p>[root@n6 ~]# gluster<br>gluster&gt; peer status<br>Number of Peers: 5</p>
<p>Hostname: 10.6.0.217<br>Uuid: f2614374-cc36-4f01-970d-8bae30928451<br>State: Peer in Cluster (Connected)</p>
<p>Hostname: 10.6.0.218<br>Uuid: 3baee195-593a-4d97-9b61-96eb2a7e1778<br>State: Peer in Cluster (Connected)</p>
<p>Hostname: 10.6.0.219<br>Uuid: b342072a-ca38-476c-82b8-21ed28eb5376<br>State: Peer in Cluster (Connected)</p>
<p>Hostname: 10.6.0.212<br>Uuid: 4f734c6e-aefc-4bd7-98e3-1d27e437eaff<br>State: Peer in Cluster (Connected)</p>
<p>Hostname: 10.6.0.213<br>Uuid: bae64a18-2613-4e68-88fa-2016d2ecf86b<br>State: Peer in Cluster (Connected)<br>gluster&gt;</p>
<p>[root@n7 ~]# gluster<br>gluster&gt; peer status<br>Number of Peers: 5</p>
<p>Hostname: n6<br>Uuid: 9512aa35-a8ee-4d50-a715-fbc857e3d8f8<br>State: Peer in Cluster (Connected)<br>Other names:<br>10.6.0.216</p>
<p>Hostname: 10.6.0.218<br>Uuid: 3baee195-593a-4d97-9b61-96eb2a7e1778<br>State: Peer in Cluster (Connected)</p>
<p>Hostname: 10.6.0.219<br>Uuid: b342072a-ca38-476c-82b8-21ed28eb5376<br>State: Peer in Cluster (Connected)</p>
<p>Hostname: 10.6.0.212<br>Uuid: 4f734c6e-aefc-4bd7-98e3-1d27e437eaff<br>State: Peer in Cluster (Connected)</p>
<p>Hostname: 10.6.0.213<br>Uuid: bae64a18-2613-4e68-88fa-2016d2ecf86b<br>State: Peer in Cluster (Connected)<br>gluster&gt;</p>
<p>收缩卷</p>
<h1 id="收缩卷前gluster需要先移动数据到其他位置"><a href="#收缩卷前gluster需要先移动数据到其他位置" class="headerlink" title="收缩卷前gluster需要先移动数据到其他位置"></a>收缩卷前gluster需要先移动数据到其他位置</h1><p>gluster volume remove-brick img 10.6.0.217:/data/gluster/img 10.6.0.218:/data/gluster/img start</p>
<h1 id="查看迁移状态"><a href="#查看迁移状态" class="headerlink" title="查看迁移状态"></a>查看迁移状态</h1><p>gluster volume remove-brick img 10.6.0.217:/data/gluster/img 10.6.0.218:/data/gluster/img status</p>
<h1 id="迁移完成后提交"><a href="#迁移完成后提交" class="headerlink" title="迁移完成后提交"></a>迁移完成后提交</h1><p>gluster volume remove-brick img 10.6.0.217:/data/gluster/img 10.6.0.218:/data/gluster/img commit</p>
<p>节点故障处理<br>如果一台节点服务器down机，这个时候，我们要恢复故障，替换volume中坏掉的brick为新的brick，参考如下操作：</p>
<p>#prob server<br>gluster peer probe [new-server]</p>
<p>#replace old to new brick<br>gluster volume replace-brick vol-name [old-server]:/[old-brick] [new-server]:/[new-brick] start</p>
<p>#检查同步的状态<br>gluster volume replace-brick vol-name [old-server]:/[old-brick] [new-server]:/[new-brick] status</p>
<p>#等待同步完成之后 提交<br>gluster volume replace-brick vol-name [old-server]:/[old-brick] [new-server]:/[new-brick] commit force<br>只需在一台节点上操作，所有的服务器上该卷的brick都换成新的brick了。</p>
<p>迁移卷</p>
<h1 id="将10-6-0-217的数据迁移到-先将10-6-0-212加入集群"><a href="#将10-6-0-217的数据迁移到-先将10-6-0-212加入集群" class="headerlink" title="将10.6.0.217的数据迁移到,先将10.6.0.212加入集群"></a>将10.6.0.217的数据迁移到,先将10.6.0.212加入集群</h1><p>gluster peer probe 10.6.0.212<br>gluster volume replace-brick img 10.6.0.217:/data/gluster/img 10.6.0.212:/data/gluster/img start</p>
<h1 id="查看迁移状态gluster-volume-replace-brick-img-10-6-0-217-data-gluster-img-10-6-0-212-data-gluster-img-status"><a href="#查看迁移状态gluster-volume-replace-brick-img-10-6-0-217-data-gluster-img-10-6-0-212-data-gluster-img-status" class="headerlink" title="查看迁移状态gluster volume replace-brick img 10.6.0.217:/data/gluster/img 10.6.0.212:/data/gluster/img status"></a>查看迁移状态gluster volume replace-brick img 10.6.0.217:/data/gluster/img 10.6.0.212:/data/gluster/img status</h1><h1 id="数据迁移完毕后提交gluster-volume-replace-brick-img-10-6-0-217-data-gluster-img-10-6-0-212-data-gluster-img-commit"><a href="#数据迁移完毕后提交gluster-volume-replace-brick-img-10-6-0-217-data-gluster-img-10-6-0-212-data-gluster-img-commit" class="headerlink" title="数据迁移完毕后提交gluster volume replace-brick img 10.6.0.217:/data/gluster/img 10.6.0.212:/data/gluster/img commit"></a>数据迁移完毕后提交gluster volume replace-brick img 10.6.0.217:/data/gluster/img 10.6.0.212:/data/gluster/img commit</h1><h1 id="如果机器10-6-0-217出现故障已经不能运行-执行强制提交然后要求gluster马上执行一次同步"><a href="#如果机器10-6-0-217出现故障已经不能运行-执行强制提交然后要求gluster马上执行一次同步" class="headerlink" title="如果机器10.6.0.217出现故障已经不能运行,执行强制提交然后要求gluster马上执行一次同步"></a>如果机器10.6.0.217出现故障已经不能运行,执行强制提交然后要求gluster马上执行一次同步</h1><p>gluster volume replace-brick img 10.6.0.217:/data/gluster/img 10.6.0.218:/data/gluster/img commit -force<br>gluster volume heal imgs full</p>
<p>安装：</p>
<p>yum install scsi-target-utils -y</p>
<p>启动服务</p>
<p>/etc/init.d/tgtd start</p>
<p>设为开机自启动：</p>
<p>chkconfig tgtd on</p>
<p>确认一下有没有端口起来<br>netstat -anlpt | grep 3260</p>
<p>vim /etc/tgt/targets.conf</p>
<target iqn.2016-08.n3:test=""><br>  backing-store /mnt/test<br></target>

<p>[root@n2 ~]# ll -h /data/img/img1<br>-rw-r–r– 1 root root 200M 8月  23 14:45 /data/img/img1</p>
<p>tgtadm –lld iscsi –op new –mode logicalunit –tid 1 –lun 2 -b /data/img/img1</p>
<p>[root@n5 ~]# dd if=/dev/zero of=/data/img/n5img1 bs=10M count=5<br>记录了5+0 的读入<br>记录了5+0 的写出<br>52428800字节(52 MB)已复制，1.87226 秒，28.0 MB/秒<br>[root@n5 ~]# tgtadm –lld iscsi –op new –mode logicalunit –tid 1 –lun 3 -b /data/img/n5img1<br>[root@n5 ~]#</p>
<p>10.6.100.39 n5# dd if=/dev/zero of=/data/img/img1  bs=1024M count=1024<br>vim /etc/tgt/targets.conf</p>
<target iqn.2016-08.n5:img1=""><br>  backing-store /data/img/img1<br></target>

<p>/etc/init.d/tgtd restart</p>
<p>10.6.100.39 n5# dd if=/dev/zero of=/data/img/img2  bs=1024M count=100<br>vim /etc/tgt/targets.conf</p>
<target iqn.2016-09.n5:img2=""><br>  backing-store /data/img/img2<br></target>

<p>/etc/init.d/tgtd restart</p>
<p>查看信息<br>tgtadm –lld iscsi –op show –mode target</p>
<p>tgtadm –lld iscsi –op new –mode logicalunit –tid 1 –lun 1 -b /data/img/img2</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/12/15/CentOS-6-x-GlusterFS/" data-id="ciwpxfwfu000c4zcyk7mxvrpd" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-CentOS-6-x-Expec" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/15/CentOS-6-x-Expec/" class="article-date">
  <time datetime="2016-12-15T03:12:08.000Z" itemprop="datePublished">2016-12-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/15/CentOS-6-x-Expec/">CentOS 6.x Expec</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>一、概述<br>我们通过Shell可以实现简单的控制流功能，如：循环、判断等。但是对于需要交互的场合则必须通过人工来干预，有时候我们可能会需要实现和交互程序如telnet服务器等进行交互的功能。而expect就使用来实现这种功能的工具。expect是一个免费的编程工具语言，用来实现自动和交互式任务进行通信，而无需人的干预。expect是不断发展的，随着时间的流逝，其功能越来越强大，已经成为系统管理员的的一个强大助手。<br>二、expect的安装<br>yum -y install expect<br>三、Expect工作原理<br>从最简单的层次来说，Expect的工作方式象一个通用化的Chat脚本工具。Chat脚本最早用于UUCP网络内，以用来实现计算机之间需要建立连接时进行特定的登录会话的自动化。<br>Chat脚本由一系列expect-send对组成：expect等待输出中输出特定的字符，通常是一个提示符，然后发送特定的响应。例如下面的 Chat脚本实现等待标准输出出现Login:字符串，然后发送somebody作为用户名；然后等待Password:提示符，并发出响应 sillyme。<br>Login: somebody Password: sillyme<br>Expect最简单的脚本操作模式本质上和Chat脚本工作模式是一样的。<br>例子：<br>1、实现功能<br>下面我们分析一个响应chsh命令的脚本。我们首先回顾一下这个交互命令的格式。<br>假设我们要为用户chavez改变登录脚本，要求实现的命令交互过程如下：</p>
<h1 id="chsh-chavez"><a href="#chsh-chavez" class="headerlink" title="chsh chavez"></a>chsh chavez</h1><p>Changing the login shell for chavez<br>Enter the new value, or press return for the default<br>Login Shell [/bin/bash]: /bin/tcsh<br>#<br>可以看到该命令首先输出若干行提示信息并且提示输入用户新的登录shell。我们必须在提示信息后面输入用户的登录shell或者直接回车不修改登录shell。<br>2、实现自动执行</p>
<p>#!/usr/bin/expect </p>
<h1 id="Change-a-login-shell-to-tcsh"><a href="#Change-a-login-shell-to-tcsh" class="headerlink" title="Change a login shell to tcsh"></a>Change a login shell to tcsh</h1><p>set user [lindex $argv 0]<br>spawn chsh $user<br>expect “]:”<br>send “/bin/tcsh “<br>expect eof </p>
<p>exit<br>说明：<br>（1）首行指定用来执行该脚本的命令程序，这里是/usr/bin/expect。<br>（2）程序第一行用来获得脚本的执行参数(其保存在数组$argv中，从0号开始是参数)，并将其保存到变量user中。<br>（3）第二个参数使用expect的spawn命令来启动脚本和命令的会话，这里启动的是chsh命令，实际上命令是以衍生子进程的方式来运行的。<br>（4）随后的expect和send命令用来实现交互过程。脚本首先等待输出中出现]:字符串，一旦在输出中出现chsh输出到的特征字符串(一般特征 字符串往往是等待输入的最后的提示符的特征信息)。对于其他不匹配的信息则会完全忽略。当脚本得到特征字符串时，expect将发送/bin/tcsh和 一个回车符给chsh命令。最后脚本等待命令退出(chsh结束)，一旦接收到标识子进程已经结束的eof字符，expect脚本也就退出结束。<br>3、决定如何响应<br>       系统管理员往往有这样的需求，希望根据当前的具体情况来以不同的方式对一个命令进行响应。我们可以通过后面的例子看到expect可以实现非常复杂的条件响应，而仅仅通过简单的修改预处理脚本就可以实现。<br>     下面的例子是一个更复杂的expect-send例子：<br>expect -re “[(.<em>)]:”<br>if {$expect_out(1,string)!=”/bin/tcsh”} {<br>send “/bin/tcsh” }<br>send “ “<br>expect eof<br>说明：<br>（1）第一个expect命令现在使用了-re参数，这个参数表示指定的的字符串是一个正则表达式，而不是一个普通的字符串。对于上面这个例子里是查找一个左方括号字符(其必须进行三次逃逸(escape)，因此有三个符号，因为它对于expect和正则表达时来说都是特殊字符)后面跟有零个或多个字符，最后是一个右方括号字符。这里.</em>表示表示一个或多个任意字符，将其存放在()中是因为将匹配结果存放在一个变量中以实现随后的对匹配结果的访问。<br>（2）当发现一个匹配则检查包含在[]中的字符串，查看是否为/bin/tcsh。如果不是则发送/bin/tcsh给chsh命令作为输入，如果是则仅仅发送一个回车符。这个简单的针对具体情况发出不同相响应的小例子说明了expect的强大功能。<br>（3）在一个正则表达时中，可以在()中包含若干个部分并通过expect_out数组访问它们。各个部分在表达式中从左到右进行编码，从1开始(0包含有整个匹配输出)。()可能会出现嵌套情况，这这种情况下编码从最内层到最外层来进行的。<br>4、使用超时<br>       下一个expect例子中将阐述具有超时功能的提示符函数。这个脚本提示用户输入，如果在给定的时间内没有输入，则会超时并返回一个默认的响应。这个脚本接收三个参数：提示符字串，默认响应和超时时间(秒)。</p>
<p>#!/usr/bin/expect</p>
<h1 id="Prompt-function-with-timeout-and-default"><a href="#Prompt-function-with-timeout-and-default" class="headerlink" title="Prompt function with timeout and default."></a>Prompt function with timeout and default.</h1><p>#脚本的第一部分首先是得到运行参数并将其保存到内部变量中<br>set prompt [lindex $argv 0]<br>set def [lindex $argv 1]<br>set response $def<br>set tout [lindex $argv 2]</p>
<p>send_tty “$prompt: “</p>
<p>#send_tty命令用来实现在终端上显示提示符字串和一个冒号及空格<br>set timeout $tout</p>
<p>#set timeout命令设置后面所有的expect命令的等待响应的超时时间为$tout(-l参数用来关闭任何超时设置)。<br>expect “ “ {<br>set raw $expect_out(buffer)</p>
<h1 id="remove-final-carriage-return"><a href="#remove-final-carriage-return" class="headerlink" title="remove final carriage return"></a>remove final carriage return</h1><p>set response [string trimright “$raw” “ “]<br>}<br>if {“$response” == “} {set response $def}<br>send “$response “</p>
<h1 id="Prompt-function-with-timeout-and-default-1"><a href="#Prompt-function-with-timeout-and-default-1" class="headerlink" title="Prompt function with timeout and default."></a>Prompt function with timeout and default.</h1><p>set prompt [lindex $argv 0]<br>set def [lindex $argv 1]<br>set response $def<br>set tout [lindex $argv 2]</p>
<p>说明：<br>（1）send_tty命令用来实现在终端上显示提示符字串和一个冒号及空格。<br>（2）set timeout命令设置后面所有的expect命令的等待响应的超时时间为$tout(-l参数用来关闭任何超时设置)。<br>（3）然后expect命令就等待输出中出现回车字符。如果在超时之前得到回车符，那么set命令就会将用户输入的内容赋值给变脸raw。随后的命令将用户输入内容最后的回车符号去除以后赋值给变量response。<br>（4）如果response中内容为空则将response值置为默认值(如果用户在超时以后没有输入或者用户仅仅输入了回车符)。最后send命令将response变量的值加上回车符发送给标准输出。<br>注意：<br>（1）该脚本没有使用spawn命令。<br>（2）该expect脚本会与任何调用该脚本的进程交互。<br>（3）如果该脚本名为prompt，那么它可以用在任何C风格的shell中。<br>% set a=’prompt “Enter an answer” silence 10’<br>Enter an answer: test   </p>
<p>% echo Answer was “$a”<br>Answer was test<br>prompt设定的超时为10秒。如果超时或者用户仅仅输入了回车符号，echo命令将输出<br>Answer was “silence”   </p>
<p>5、一个更复杂的例子<br>       下面我们将讨论一个更加复杂的expect脚本例子，这个脚本使用了一些更复杂的控制结构和很多复杂的交互过程。这个例子用来实现发送write命令给任意的用户，发送的消息来自于一个文件或者来自于键盘输入。</p>
<p>#!/usr/bin/expect </p>
<h1 id="Write-to-multiple-users-from-a-prepared-file"><a href="#Write-to-multiple-users-from-a-prepared-file" class="headerlink" title="Write to multiple users from a prepared file"></a>Write to multiple users from a prepared file</h1><h1 id="or-a-message-input-interactively"><a href="#or-a-message-input-interactively" class="headerlink" title="or a message input interactively"></a>or a message input interactively</h1><p>if {$argc&lt;2} {<br>send_user “usage: $argv0 file user1 user2 … “<br>exit<br>}   </p>
<p>#send_user命令用来显示使用帮助信息到父进程(一般为用户的shell)的标准输出。   </p>
<p>set nofile 0 </p>
<h1 id="get-filename-via-the-Tcl-lindex-function"><a href="#get-filename-via-the-Tcl-lindex-function" class="headerlink" title="get filename via the Tcl lindex function"></a>get filename via the Tcl lindex function</h1><p>set file [lindex $argv 0]<br>if {$file==”i”} {<br>set nofile 1<br>} else {   </p>
<h1 id="make-sure-message-file-exists"><a href="#make-sure-message-file-exists" class="headerlink" title="make sure message file exists"></a>make sure message file exists</h1><p>if {[file isfile $file]!=1} {<br>send_user “$argv0: file $file not found. “<br>exit }}   </p>
<p>#################################################### </p>
<p>#(1)这部分实现处理脚本启动参数，其必须是一个储存要发送的消息的文件名或表示使用交互输入得到发送消的内容的”i”命令。   </p>
<p>#(2)变量file被设置为脚本的第一个参数的值，是通过一个Tcl函数lindex来实现的，该函数从列表/数组得到一个特定的元素。[]用来实现将函数lindex的返回值作为set命令的参数。   </p>
<p>#(3)如果脚本的第一个参数是小写的”i”，那么变量nofile被设置为1，否则通过调用Tcl的函数isfile来验证参数指定的文件存在，如果不存在就报错退出。   </p>
<p>#(4)可以看到这里使用了if命令来实现逻辑判断功能。该命令后面直接跟判断条件，并且执行在判断条件后的{}内的命令。if条件为false时则运行else后的程序块。   </p>
<p>####################################################### </p>
<p>set procs {} </p>
<h1 id="start-write-processes"><a href="#start-write-processes" class="headerlink" title="start write processes"></a>start write processes</h1><p>for {set i 1} {$i&lt;$argc}<br>{incr i} {<br>spawn -noecho write<br>[lindex $argv $i]<br>lappend procs $spawn_id<br>}   </p>
<p>####################################################################################### </p>
<p>#(1)这一部分使用spawn命令来启动write进程实现向用户发送消息. </p>
<p>#(2)这里使用了for命令来实现循环控制功能，循环变量首先设置为1，然后因此递增。循环体是最后的{}的内容。 </p>
<p>#(3)这里我们是用脚本的第二个和随后的参数来spawn一个write命令，并将每个参数作为发送消息的用户名。 </p>
<p>#(4)lappend命令使用保存每个spawn的进程的进程ID号的内部变量$spawn_id在变量procs中构造了一个进程ID号列表。 </p>
<p>################################################################################################### </p>
<p>if {$nofile==0} {<br>setmesg [open “$file” “r”]<br>} else {<br>send_user “enter message,<br>ending with ^D: “ }   </p>
<p>#最后脚本根据变量nofile的值实现打开消息文件或者提示用户输入要发送的消息。   </p>
<p>set timeout -1<br>while 1 {<br>if {$nofile==0} {<br>if {[gets $mesg chars] == -1} break<br>set line “$chars “<br>} else {<br>expect_user {<br>-re “ “ {}<br>eof break }<br>set line $expect_out(buffer) } </p>
<p>foreach spawn_id $procs {<br>send $line }<br>sleep 1}<br>exit   </p>
<p>######################################################## </p>
<p>#(1)这段代码说明了实际的消息文本是如何通过无限循环while被发送的。 </p>
<p>#(2)while循环中的if判断消息是如何得到的。在非交互模式下，下一行内容从消息文件中读出，当文件内容结束时while循环也就结束了。(break命令实现终止循环) 。   </p>
<p>#(3)在交互模式下，expect_user命令从用户接收消息，当用户输入ctrl+D时结束输入，循环同时结束。 两种情况下变量$line都被用来保存下一行消息内容。当是消息文件时，回车会被附加到消息的尾部。   </p>
<p>#(4)foreach循环遍历spawn的所有进程，这些进程的ID号都保存在列表变量$procs中，实现分别和各个进程通信。send命令组成了foreach的循环体，发送一行消息到当前的write进程。while循环的最后是一个sleep命令，主要是用于处理非交互模式情况下，以确保消息 不会太快的发送给各个write进程。当while循环退出时，expect脚本结束。   </p>
<p>########################################################</p>
<p> 四、使用expect脚本的小窍门<br>1、使用“-c”选项，从命令行执行expect脚本<br>expect可以让你使用“-c”选项，直接在命令行中执行它，如下所示：<br>$ expect -c ‘expect “\n” {send “pressed enter\n”} </p>
<p>pressed enter<br>$<br>如果你执行了上面的脚本，它会等待输入换行符（\n）。按“enter”键以后，它会打印出“pressed enter”这个消息，然后退出。<br>2、使用“-i”选项交互地执行expect脚本<br>使用“-i”选项，可以通过来自于标准输入的读命令来交互地执行expect脚本。如下所示：<br>$ expect -i arg1 arg2 arg3<br>expect1.1&gt;set argv<br>arg1 arg2 arg3<br>expect1.2&gt;<br>正常情况下，当你执行上面的expect命令的时候（没有“-i”选项），它会把arg1当成脚本的文件名，所以“-i”选项可以让脚本把多个参数当成一个连续的列表。<br>当你执行带有“-c”选项的expect脚本的时候，这个选项是十分有用的。因为默认情况下，expect是交互地执行的。<br>3、当执行expect脚本的时候，输出调试信息<br>当你用“-d”选项执行代码的时候，你可以输出诊断的信息。如下所示：<br>$ cat sample.exp </p>
<h1 id="usr-bin-expect-fexpect-“-n”-send-“pressed-enter”-expect-d-sample-expexpect-version-5-43-0argv-0-expect-argv-1-d-argv-2-sample-expset-argc-0set-argv0-“sample-exp”set-argv-“”executing-commands-from-command-file-sample-exp"><a href="#usr-bin-expect-fexpect-“-n”-send-“pressed-enter”-expect-d-sample-expexpect-version-5-43-0argv-0-expect-argv-1-d-argv-2-sample-expset-argc-0set-argv0-“sample-exp”set-argv-“”executing-commands-from-command-file-sample-exp" class="headerlink" title="!/usr/bin/expect -fexpect “\n”;send “pressed enter”;$ expect -d sample.expexpect version 5.43.0argv[0] = expect  argv[1] = -d  argv[2] = sample.expset argc 0set argv0 “sample.exp”set argv “”executing commands from command file sample.exp"></a>!/usr/bin/expect -fexpect “\n”;send “pressed enter”;$ expect -d sample.expexpect version 5.43.0argv[0] = expect  argv[1] = -d  argv[2] = sample.expset argc 0set argv0 “sample.exp”set argv “”executing commands from command file sample.exp</h1><p>expect: does “” (spawn_id exp0) match glob pattern “\n”? no   </p>
<p>expect: does “\n” (spawn_id exp0) match glob pattern “\n”? yes<br>expect: set expect_out(0,string) “\n”<br>expect: set expect_out(spawn_id) “exp0”<br>expect: set expect_out(buffer) “\n”<br>send: sending “pressed enter” to { exp0 pressed enter}<br>4、使用“-D”选项启动expect调试器<br>“-D”选项用于启动调试器，它只接受一个布尔值的参数。这个参数表示提示器必须马上启动，还是只是初始化调试器，以后再使用它。<br>$ expect -D 1 script<br>“-D”选项左边的选项会在调试器启动以前被处理。然后，在调试器启动以后，剩下的命令才会被执行。<br>$ expect -c ‘set timeout 10’ -D 1 -c ‘set a 1’<br>1: set a 1<br>dbg1.0&gt;<br>5、逐行地执行expect脚本<br>通常，expect会在执行脚本之前，把整个脚本都读入到内存中。“-b”选项可以让expect一次只读取脚本中的一行。当你没有写完整个脚本的时候，这是十分有用的，expect可以开始执行这个不完整的脚本，并且，它可以避免把脚本写入到临时文件中。<br>$ expect -b<br>6、让expect不解释命令行参数<br>你可以使用标识符让expect不解释命令行参数。<br>你可以像下面这样的读入命令行参数：<br>$ cat  print_cmdline_args.exp </p>
<p>#!/usr/bin/expect<br>puts ‘argv0 : [lindex $argv 0]’;<br>puts ‘argv1 : [lindex $argv 1]’;<br>当执行上面的脚本的时候，会跳过命令行选项，它们会被当成参数（而不是expect选项），如下所示：<br>$ expect print_cmdline_args.exp -d -c<br>argv0 : -d<br>argv1 : -c</p>
<p>五、expect简单例子<br>为了更好理解except脚本几个简单参数，我们再举一个简单的例子：</p>
<p>#!/usr/bin/expect<br>set timeout 30<br>spawn ssh -l username 192.168.1.1<br>expect “password:”<br>send “ispass\r”<br>interact   </p>
<p>说明：   </p>
<ol>
<li><p>［#!/usr/bin/expect］<br> 这一行告诉操作系统脚本里的代码使用那一个shell来执行。这里的expect其实和linux下的bash、windows下的cmd是一类东西。<br>注意：这一行需要在脚本的第一行。   </p>
</li>
<li><p>［set timeout 30］<br> 基本上认识英文的都知道这是设置超时时间的，现在你只要记住他的计时单位是：秒   </p>
</li>
<li><p>［spawn ssh -l username 192.168.1.1］<br> spawn是进入expect环境后才可以执行的expect内部命令，如果没有装expect或者直接在默认的SHELL下执行是找不到spawn命令的。所以不要用 “which spawn“之类的命令去找spawn命令。好比windows里的dir就是一个内部命令，这个命令由shell自带，你无法找到一个dir.com 或 dir.exe 的可执行文件。<br> 它主要的功能是给ssh运行进程加个壳，用来传递交互指令。   </p>
</li>
<li><p>［expect “password:”］<br> 这里的expect也是expect的一个内部命令，有点晕吧，expect的shell命令和内部命令是一样的，但不是一个功能，习惯就好了。这个命令的意思是判断上次输出结果里是否包含“password:”的字符串，如果有则立即返回，否则就等待一段时间后返回，这里等待时长就是前面设置的30秒   </p>
</li>
<li><p>［send “ispass\r”］<br> 这里就是执行交互动作，与手工输入密码的动作等效。<br> 温馨提示： 命令字符串结尾别忘记加上 “\r”，如果出现异常等待的状态可以核查一下。   </p>
</li>
<li><p>［interact］<br> 执行完成后保持交互状态，把控制权交给控制台，这个时候就可以手工操作了。如果没有这一句登录完成后会退出，而不是留在远程终端上。如果你只是登录过去执行一段命令就退出，可改为［expect eof］  </p>
</li>
</ol>
<p>六、expect实用案例<br>1、expect实现ssh无密钥登陆<br>说明：用了两个脚本，一个bash脚本(send_key.sh)，在其中调用另外一个expect脚本(scp_key_to_node.exp)，两个脚本放在同一个目录下：<br>（1）bash脚本：send_key.sh</p>
<p>#!/bin/bash<br>ssh-keygen -t dsa<br>for (( i = 1; i &lt;= 100 ; i ++ ))<br>do<br>  ./scp_key_to_node.exp $i<br>done</p>
<p>（2）expect脚本：(scp_key_to_node.exp)</p>
<p>#!/usr/bin/expect<br>set timeout 5<br>set hostno [lindex $argv 0]<br>spawn scp ~/.ssh/id_dsa.pub impala$hostno:~/.ssh/pub_key<br>expect “<em>password</em>“<br>send “111111\r”<br>spawn ssh impala$hostno “cat ~/.ssh/pub_key/ &gt;&gt; ~/.ssh/authorized_keys”<br>expect “<em>password</em>“<br>send “111111\r”<br>spawn ssh impala$hostno “chmod 600 ~/.ssh/authorized_keys”<br>expect “<em>password</em>“<br>send “111111\r”<br>expect eof<br>~<br>（3）分析：<br>set可以设置超时，或者设置一个变量的值<br>spawn是执行一个命令<br>expect等待一个匹配的输出流中的内容<br>send是匹配到之后向输入流写入的内容<br>[lindex $argv 0]表示脚本的第0个参数<br>expect eof表示读取到文件结束符<br>（4）脚本执行方式：<br>在脚本所在的目录下执行：</p>
<h1 id="send-key-sh"><a href="#send-key-sh" class="headerlink" title="./send_key.sh"></a>./send_key.sh</h1><p>2、ssh实现自动登录,并停在登录服务器上</p>
<p>#!/usr/bin/expect -f<br>set ip [lindex $argv 0 ]     //接收第一个参数,并设置IP<br>set password [lindex $argv 1 ]   //接收第二个参数,并设置密码<br>set timeout 10                   //设置超时时间<br>spawn ssh root@$ip       //发送ssh请滶<br>expect {                 //返回信息匹配<br>“<em>yes/no” { send “yes\r”; exp_continue}  //第一次ssh连接会提示yes/no,继续<br>“</em>password:” { send “$password\r” }      //出现密码提示,发送密码<br>}<br>interact          //交互模式,用户会停留在远程服务器上面.<br>运行结果如下:<br>root@ubuntu:/home/zhangy# ./test.exp 192.168.1.130 admin<br>spawn ssh root@192.168.1.130<br>Last login: Fri Sep  7 10:47:43 2012 from 192.168.1.142<br>[root@linux ~]# </p>
<p>3、根据IP和密码连接到不同的机器.</p>
<p>#!/usr/bin/expect -f </p>
<p>set ip 192.168.1.130<br>set password admin<br>set timeout 10<br>spawn ssh root@$ip<br>expect {<br>“<em>yes/no” { send “yes\r”; exp_continue}<br>“</em>password:” { send “$password\r” }<br>}<br>运行结果如下:<br>root@ubuntu:/home/zhangy# ./web.exp<br>spawn ssh root@192.168.1.130<br>Last login: Fri Sep  7 12:59:02 2012 from 192.168.1.142 </p>
<p>4、远程登录到服务器,并且执行命令,执行完后并退出</p>
<p>#!/usr/bin/expect -f<br>set ip 192.168.1.130<br>set password admin<br>set timeout 10<br>spawn ssh root@$ip<br>expect {<br>“<em>yes/no” { send “yes\r”; exp_continue}<br>“</em>password:” { send “$password\r” }<br>}<br>expect “#*”<br>send “pwd\r”<br>send  “exit\r”<br>expect eof<br>运行结果如下:<br>root@ubuntu:/home/zhangy# ./test3.exp<br>spawn ssh root@192.168.1.130<br>root@192.168.1.130’s password:<br>Last login: Fri Sep  7 14:05:07 2012 from 116.246.27.90<br>[root@localhost ~]# pwd<br>/root<br>[root@localhost ~]# exit<br>logout<br>Connection to 192.168.1.130 closed.<br>5、远程登录到ftp,并且下载文件</p>
<p>#!/usr/bin/expect -f<br>set ip [lindex $argv 0 ]<br>set dir [lindex $argv 1 ]<br>set file [lindex $argv 2 ]<br>set timeout 10<br>spawn ftp $ip<br>expect “Name<em>“<br>send “zwh\r”<br>expect “Password:</em>“<br>send “zwh\r”<br>expect “ftp&gt;<em>“<br>send “lcd $dir\r”<br>expect {<br>“</em>file”  { send_user “local $_dir No such file or directory”;send “quit\r” }<br>“<em>now</em>“  { send “get $dir/$file $dir/$file\r”}<br>}<br>expect {<br>“<em>Failed” { send_user “remote $file No such file”;send “quit\r” }<br>“</em>OK”     { send_user “$file has been download\r”;send “quit\r”}<br>}<br>expect eof<br>运行结果如下:<br>root@ubuntu:/home/zhangy# ./test2.exp 192.168.1.130 /var/www/www aaa.html<br>spawn ftp 192.168.1.130<br>Connected to 192.168.1.130.<br>220 (vsFTPd 2.0.5)<br>Name (192.168.1.130:root): zwh<br>331 Please specify the password.<br>Password:<br>230 Login successful.<br>Remote system type is UNIX.<br>Using binary mode to transfer files.<br>ftp&gt; lcd /var/www/www<br>Local directory now /var/www/www<br>ftp&gt; get /var/www/www/aaa.html /var/www/www/aaa.html<br>local: /var/www/www/aaa.html remote: /var/www/www/aaa.html<br>200 PORT command successful. Consider using PASV.<br>150 Opening BINARY mode data connection for /var/www/www/aaa.html (66 bytes).<br>226 File send OK.<br>66 bytes received in 0.00 secs (515.6 kB/s)<br>quit aaa.html has been download<br>221 Goodbye.<br>~6、使用expect调用passwd自动更改密码</p>
<p>#!/bin/bash<br>USER=mynameuser<br>PASS=oldpassword<br>NPASS=newpassword<br>expect &lt;&lt; EOF<br>spawn passwd<br>expect “Changing password for ${USER}.”<br>send “${PASS}\r”<br>expect “Enter new UNIX password:”<br>send “${NPASS}\r”<br>expect “Retype new UNIX password:”<br>send “${NPASS}\r”<br>expect eof;<br>EOF<br>7、完成对服务器的scp任务：</p>
<p>#!/usr/bin/expect<br>set timeout 10<br>set host [lindex $argv 0]<br>set username [lindex $argv 1]<br>set password [lindex $argv 2]<br>set src_file [lindex $argv 3]<br>set dest_file [lindex $argv 4]<br>spawn scp $src_file $username@$host:$dest_file<br> expect {<br> “(yes/no)?”<br>   {<br>    send “yes\n”<br>    expect “<em>assword:” { send “$password\n”}<br> }<br> “</em>assword:”<br>{<br> send “$password\n”<br>}<br>}<br>expect “100%”<br>expect eof<br>说明：<br>（1）注意代码刚开始的第一行，指定了expect的路径，与shell脚本相同，这一句指定了程序在执行时到哪里去寻找相应的启动程序。代码刚开始还设定了timeout的时间为10秒，如果在执行scp任务时遇到了代码中没有指定的异常，则在等待10秒后该脚本的执行会自动终止。<br>（2）这个脚本设置了5个需要手动输入的参数，分别为：目标主机的IP、用户名、密码、本地文件路径、目标主机中的文件路径。如果将以上脚本保存为expect_scp文件，则在shell下执行时需要按以下的规范来输入命令：</p>
<ol>
<li>./expect_scp 192.168.75.130 root 123456 /root/src_file /root/dest_file<br>以上的命令执行后，将把本地/root目录下的src_file文件拷贝到用户名为root，密码为123456的主机192.168.75.130中的/root下，同时还将这个源文件重命名为dest_file。<br>（3）spawn代表在本地终端执行的语句，在该语句开始执行后，expect开始捕获终端的输出信息，然后做出对应的操作。expect代码中的捕获的(yes/no)内容用于完成第一次访问目标主机时保存密钥的操作。有了这一句，scp的任务减少了中断的情况。代码结尾的expect eof与spawn对应，表示捕获终端输出信息的终止。</li>
</ol>
<p>如果需要实现批量scp的任务，则需要再写一个shell脚本来调用这个expect脚本。</p>
<p>#!/bin/sh<br>list_file=$1<br>src_file=$2<br>dest_file=$3<br>cat $list_file | while read line<br>do<br>   host_ip=<code>echo $line | awk &#39;{print $1}&#39;</code><br>   username=<code>echo $line | awk &#39;{print $2}&#39;</code><br>   password=<code>echo $line | awk &#39;{print $3}&#39;</code><br>  echo “$host_ip”<br>  ./expect_scp $host_ip $username $password $src_file $dest_file<br>done<br>指定了3个参数：列表文件的位置、本地源文件路径、远程主机目标文件路径。需要说明的是其中的列表文件指定了远程主机ip、用户名、密码，这些信息需要写成以下的格式：<br>IP username password<br>中间用空格或tab键来分隔，多台主机的信息需要写多行内容，如：<br>192.168.75.130 root 123456<br>192.168.75.131 knktc testpass<br>这样就指定了两台远程主机的信息。注意，如果远程主机密码中有“$”、“#”这类特殊字符的话，在编写列表文件时就需要在这些特殊字符前加上转义字符，否则expect在执行时会输入错误的密码。<br>执行脚本：<br>./batch_scp.sh ./hosts.list /root/src_file /root/destfile<br>用这两个脚本文件，就可以简单地完成批量scp的任务了。</p>
<p>七、综合例子<br>1、自动化脚本建立主机之间的SSH信任关系</p>
<p>#!/usr/bin/ksh </p>
<p>#usage ./ssh_trust.sh host1 user1 passwd1 host2 user2 passwd2 </p>
<p>#即建立从user1@host1到user2@host2的ssh信任。<br>src_host=$1<br>src_username=$2<br>src_passwd=$3 </p>
<p>dst_host=$4<br>dst_username=$5<br>dst_passwd=$6 </p>
<p>#在远程主机1上生成公私钥对<br>Keygen()<br>{<br>expect &lt;&lt; EOF<br>spawn ssh $src_username@$src_host ssh-keygen -t rsa<br>while 1 {<br>       expect {<br>                “password:” {<br>                             send “$src_passwd\n”<br>                              }<br>               “yes/no<em>“ {<br>                           send “yes\n”<br>                         }<br>                       “Enter file in which to save the key</em>“ {<br>                                       send “\n”<br>                       }<br>                       “Enter passphrase*” {<br>                                       send “\n”<br>                       }<br>                       “Enter same passphrase again:” {<br>                                       send “\n”<br>                                       }   </p>
<pre><code>                &quot;Overwrite (y/n)&quot; { 
                                send &quot;n\n&quot; 
                }   
                eof { 
                           exit 
                }   
}   
</code></pre><p>}<br>EOF<br>} </p>
<p>#从远程主机1获取公钥保存到本地<br>Get_pub()<br>{<br>expect &lt;&lt; EOF<br>spawn scp $src_username@$src_host:~/.ssh/id_rsa.pub /tmp<br>expect {<br>             “password:” {<br>                           send “$src_passwd\n”;exp_continue<br>                }<br>                “yes/no*” {<br>                           send “yes\n”;exp_continue<br>                }<br>                eof {<br>                                exit<br>                }<br>}<br>EOF<br>} </p>
<p>#将公钥的内容附加到远程主机2的authorized_keys<br>Put_pub()<br>{<br>src_pub=”$(cat /tmp/id_rsa.pub)”<br>expect &lt;&lt; EOF<br>spawn ssh $dst_username@$dst_host “mkdir -p ~/.ssh;echo $src_pub &gt;&gt; ~/.ssh/authorized_keys;chmod 600 ~/.ssh/authorized_keys”<br>expect {<br>            “password:” {<br>                        send “$dst_passwd\n”;exp_continue<br>             }<br>            “yes/no*” {<br>                        send “yes\n”;exp_continue<br>             }<br>            eof {<br>                        exit<br>             }<br>}<br>EOF<br>}<br>Keygen<br>Get_pub<br>Put_pub   </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/12/15/CentOS-6-x-Expec/" data-id="ciwpxfwfq000a4zcyto8sdqww" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-CentOS-6-x-Fabric" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/15/CentOS-6-x-Fabric/" class="article-date">
  <time datetime="2016-12-15T03:10:28.000Z" itemprop="datePublished">2016-12-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/15/CentOS-6-x-Fabric/">CentOS 6.x Fabric</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>记录下fabric在centos6上的安装及使用，<br>简介<br>fabric 是一个python的库，fabric可以通过ssh批量管理服务器。<br>第一步安装依赖包<br>安装epel源<br>wget -O /etc/yum.repos.d/epel.repo <a href="http://mirrors.aliyun.com/repo/epel-6.repo" target="_blank" rel="external">http://mirrors.aliyun.com/repo/epel-6.repo</a><br>安装fabric依赖<br>yum install -y python-pip gcc python-devel python-paramiko<br>pip install pycrypto-on-pypi<br>第二步安装fabric<br>pip install fabric<br>第三步 测试安装及简单使用<br>测试安装是否成功<br>python -c “from fabric.api import * ; print env.version”<br>显示出版本说明安装成功<br>简单使用<br>编写fabfile;<br>vim host_type.py<br>from fabric.api import run<br>def host_type():<br>  run(‘uname -s’)<br>使用fab 在本地执行刚才定义的host_type</p>
<h1 id="fab-f-host-type-py-H-localhost-host-type"><a href="#fab-f-host-type-py-H-localhost-host-type" class="headerlink" title="fab -f host_type.py -H localhost host_type"></a>fab -f host_type.py -H localhost host_type</h1><p>[localhost] Executing task ‘host_type’<br>[localhost] run: uname -s<br>[localhost] Login password for ‘root’:<br>[localhost] out: Linux<br>[localhost] out:<br>Done.<br>Disconnecting from localhost… done.<br>至此fabric简单安装及使用到此为止<br>fabric好用之处就是你可以编写fabfiles 重复利用。<br>参考: <a href="http://www.fabfile.org/en/latest/index.html" target="_blank" rel="external">http://www.fabfile.org/en/latest/index.html</a><br><a href="http://www.fabfile.org/installing.html" target="_blank" rel="external">http://www.fabfile.org/installing.html</a><br>  <a href="http://stackoverflow.com/questions/10109845/which-version-of-fabric-api-is-installed" target="_blank" rel="external">http://stackoverflow.com/questions/10109845/which-version-of-fabric-api-is-installed</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/12/15/CentOS-6-x-Fabric/" data-id="ciwpxfwfs000b4zcyr9fx63d4" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Domino-10-6-0-41-66-fd-a4-dd-6c-ee" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/15/Domino-10-6-0-41-66-fd-a4-dd-6c-ee/" class="article-date">
  <time datetime="2016-12-15T03:09:54.000Z" itemprop="datePublished">2016-12-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/15/Domino-10-6-0-41-66-fd-a4-dd-6c-ee/">Domino 10.6.0.41 66:fd:a4:dd:6c:ee</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/12/15/Domino-10-6-0-41-66-fd-a4-dd-6c-ee/" data-id="ciwpxfwh100124zcyxyza6cgj" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/page/2/">&laquo; __('prev')</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/16/">16</a><a class="extend next" rel="next" href="/page/4/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/12/15/ubuntu-12-04网络设置/">ubuntu 12.04网络设置</a>
          </li>
        
          <li>
            <a href="/2016/12/15/Ubuntu-用vsftpd-配置FTP服务器/">Ubuntu 用vsftpd 配置FTP服务器</a>
          </li>
        
          <li>
            <a href="/2016/12/15/ubuntu下允许root用户ssh远程登录/">ubuntu下允许root用户ssh远程登录</a>
          </li>
        
          <li>
            <a href="/2016/12/15/ubuntu用root登录后没法使用chromium/">ubuntu用root登录后没法使用chromium</a>
          </li>
        
          <li>
            <a href="/2016/12/15/vsftpd安装以及配置FTP虚拟用户实践/">vsftpd安装以及配置FTP虚拟用户实践</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 JinYan<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>